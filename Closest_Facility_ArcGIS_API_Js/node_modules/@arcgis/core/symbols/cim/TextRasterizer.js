/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{pt2px as t}from"../../core/screenUtils.js";function e(t){return`rgb(${t.slice(0,3).toString()})`}function i(t){return`rgba(${t.slice(0,3).toString()},${t[3]})`}class s{constructor(){}rasterizeText(t,s){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const n=this._textRasterizationCanvas,o=n.getContext("2d");this.setFontProperties(o,s),this.parameters=s,this.textLines=t.split(/\r?\n/),this.lineHeight=this.computeLineHeight();const a=this.computeTextWidth(o,s),h=this.lineHeight*this.textLines.length;n.width=a,n.height=h,this.renderedLineHeight=Math.round(this.lineHeight*s.pixelRatio),this.renderedHaloSize=s.halo.size*s.pixelRatio,this.renderedWidth=a*s.pixelRatio,this.renderedHeight=h*s.pixelRatio,this.fillStyle=i(s.color),this.haloStyle=e(s.halo.color);const l=this.renderedLineHeight,d=this.renderedHaloSize;this.setFontProperties(o,s);const c=r(o.textAlign,this.renderedWidth)+d,g=d;let f=0,p=0;d>0&&this.renderHalo(o,c,g,f,p,s),p+=g,f+=c;for(const e of this.textLines)o.globalCompositeOperation="destination-out",o.fillStyle="rgb(0, 0, 0)",o.fillText(e,f,p),o.globalCompositeOperation="source-over",o.fillStyle=this.fillStyle,o.fillText(e,f,p),p+=l;const u=o.getImageData(0,0,this.renderedWidth,this.renderedHeight),m=new Uint8Array(u.data);if(s.premultiplyColors){let t;for(let e=0;e<m.length;e+=4)t=m[e+3]/255,m[e]=m[e]*t,m[e+1]=m[e+1]*t,m[e+2]=m[e+2]*t}return{size:[this.renderedWidth,this.renderedHeight],image:new Uint32Array(m.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}renderHalo(t,e,i,s,r,n){const o=this.renderedWidth,a=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=o,this._haloRasterizationCanvas.height=a;const h=this._haloRasterizationCanvas,l=h.getContext("2d");l.clearRect(0,0,o,a),this.setFontProperties(l,n),l.fillStyle=this.haloStyle,l.strokeStyle=this.haloStyle;const d=this.renderedHaloSize<3;l.lineJoin=d?"miter":"round",d?this.renderHaloEmulated(l,e,i):this.renderHaloNative(l,e,i),t.globalAlpha=this.parameters.halo.color[3],t.drawImage(h,0,0,o,a,s,r,o,a),t.globalAlpha=1}renderHaloEmulated(t,e,i){const s=this.renderedLineHeight,r=this.renderedHaloSize;for(const o of this.textLines){for(const[s,a]of n)t.fillText(o,e+r*s,i+r*a);i+=s}}renderHaloNative(t,e,i){const s=this.renderedLineHeight,r=this.renderedHaloSize;for(const n of this.textLines){const o=2*r,a=5,h=.1;for(let s=0;s<a;s++){const r=1-(a-1)*h+s*h;t.lineWidth=r*o,t.strokeText(n,e,i)}i+=s}}setFontProperties(e,i){const s=i.font,r=`${s.style} ${s.weight} ${t(i.size*i.pixelRatio)}px ${s.family}, sans-serif`;let n;switch(e.font=r,e.textBaseline="top",i.horizontalAlignment){case"left":n="left";break;case"right":n="right";break;case"center":n="center";break;default:n="left"}e.textAlign=n}computeTextWidth(t,e){let i=0;for(const r of this.textLines)i=Math.max(i,t.measureText(r).width);const s=e.font;return("italic"===s.style||"oblique"===s.style||"string"==typeof s.weight&&("bold"===s.weight||"bolder"===s.weight)||"number"==typeof s.weight&&s.weight>600)&&(i+=.3*t.measureText("A").width),i+=2*this.parameters.halo.size,Math.round(i)}computeLineHeight(){const t=1.275*this.parameters.size;return Math.round(t+2*this.parameters.halo.size)}}function r(t,e){return"center"===t?.5*e:"right"===t?e:0}const n=[];{const t=16;for(let e=0;e<360;e+=360/t)n.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}export{s as TextRasterizer,s as default};
