/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../../../../../../core/has.js";import{isSome as t,unwrap as r}from"../../../../../../core/maybe.js";import s from"../../../../../../core/workers/Connection.js";import{toQuantizationTransform as i}from"../../../../../../geometry/support/quantizationUtils.js";import{convertFromFeatureSet as o,quantizeOptimizedFeatureSet as a}from"../../../../../../layers/graphics/featureConversionUtils.js";import{queryOptimizedFeatureSet as n}from"../../../../../../layers/ogc/ogcFeatureUtils.js";import{executeQueryPBFBuffer as c,executeQuery as u}from"../../../../../../rest/query/operations/query.js";import{FeatureSetReaderJSON as m}from"../../support/FeatureSetReaderJSON.js";import{FeatureSetReaderPBF as p}from"../../support/FeatureSetReaderPBF.js";class l{constructor(e){this.service=e}destroy(){}}function f(e){return Array.isArray(e.source)}function y(e){return e&&e.capabilities&&e.collection&&e.layerDefinition}function d(t){const{capabilities:r}=t;return y(t.source)?new z(t):f(t)?new F(t):r.query.supportsFormatPBF&&e("featurelayer-pbf")?new q(t):new w(t)}async function h(e){const t=new s;return await t.open(e,{}),t}class F extends l{constructor(e){super(e),this._portsOpen=h(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return m.fromFeatureSet(r,this.service.objectIdField)}}class q extends l{async executeQuery(e,t){const{data:r}=await c(this.service.source,e,t),s=!e.quantizationParameters;return p.fromBuffer(r,this.service.geometryType,s)}}class w extends l{async executeQuery(e,s){const{source:n,capabilities:c,spatialReference:p,objectIdField:l,geometryType:f}=this.service;if(t(e.quantizationParameters)&&!c.query.supportsQuantization){const t=e.clone(),c=i(r(t.quantizationParameters));t.quantizationParameters=null;const{data:f}=await u(n,t,p,s),y=o(f,l);return a(c,y),m.fromOptimizedFeatureSet(y)}const{data:y}=await u(n,e,this.service.spatialReference,s);return"esriGeometryPoint"===f&&(y.features=y.features.filter((e=>{if(t(e.geometry)){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),m.fromFeatureSet(y,this.service.objectIdField)}}class z extends l{async executeQuery(e,t){const{capabilities:s}=this.service;if(e.quantizationParameters&&!s.query.supportsQuantization){const s=e.clone(),o=i(r(s.quantizationParameters));s.quantizationParameters=null;const c=await n(this.service.source,e,t);return a(o,c),m.fromOptimizedFeatureSet(c)}const o=await n(this.service.source,e,t);return m.fromOptimizedFeatureSet(o)}}export{l as SourceAdapter,d as createSourceAdapter};
