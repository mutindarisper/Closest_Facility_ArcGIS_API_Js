/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../../../core/Handles.js";import{releaseMaybe as t,disposeMaybe as i,destroyMaybe as s,isSome as a,isNone as r,unwrapOr as h}from"../../../core/maybe.js";import{on as n}from"../../../core/watchUtils.js";import{b as o}from"../../../chunks/mat4.js";import{c as _}from"../../../chunks/mat4f64.js";import{s as m}from"../../../chunks/vec2.js";import{a as d}from"../../../chunks/vec2f64.js";import{s as u,l,g as c}from"../../../chunks/vec3.js";import{c as p}from"../../../chunks/vec3f64.js";import{c as f,f as v}from"../../../chunks/vec4f64.js";import{earth as g}from"../../../geometry/support/Ellipsoid.js";import{rayLeighScaleHeight as b,atmosphereHeight as w,betaRayleigh as T,betaOzone as H,betaMie as R,innerAtmosphereDepth as y,computeInnerAltitudeFade as j}from"./atmosphereUtils.js";import{ChapmanAtmosphereTechniqueConfiguration as x,ChapmanAtmosphereTechnique as S}from"./ChapmanAtmosphereTechnique.js";import{Pos2Tex as U}from"../webgl-engine/lib/DefaultVertexBufferLayouts.js";import{createQuadVAO as z}from"../webgl-engine/lib/glUtil3D.js";class k{constructor(e){this._view=e,this.canRender=!0,this._skyslot=15,this._hazeSlot=16,this._cameraPosition=p(),this._projectionInverse=_(),this._viewInverse=_(),this._heightParameters=f(),this._betasRayleigh=p(),this._betasCombined=p(),this._scaleHeight=0,this._radii=d(),this._nearFar=d(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=g.radius,this._simplified=!1,this._skyStrength=1,this._hazeStrength=3,this._mieStrength=1,this._skyHazeMultiplier=1,this._skyHazePow=0,this._sunSize=1,this._sunSpread=1,this._updateRadius(g.radius)}destroy(){this._atmosphereTechnique=t(this._atmosphereTechnique),this._atmosphereHazeTechnique=t(this._atmosphereHazeTechnique),this._vao=i(this._vao),this._handles=s(this._handles)}when(){return Promise.resolve()}setSimplified(e){this._simplified=e}initializeRenderContext(t){const i=t.renderContext.rctx;this._handles=new e,a(this._view.basemapTerrain.rootTiles)&&this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(n(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add(n(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds())));const s=new x;s.haze=!1,s.simplified=this._simplified,this._atmosphereTechnique=t.shaderTechniqueRep.acquire(S,s),s.haze=!0,this._atmosphereHazeTechnique=t.shaderTechniqueRep.acquire(S,s),this._vao=z(i,U),this._scaleHeight=b*w,u(this._betasRayleigh,T[0],T[1],T[2]),u(this._betasCombined,T[0]+H[0],T[1]+H[1],T[2]+H[2])}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this._hazeSlot&&e.slot!==this._skyslot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx,i=e.offscreenRenderingHelper,s=e.slot===this._skyslot?this._atmosphereTechnique:this._atmosphereHazeTechnique,a=e.slot===this._skyslot?i.depthTexture:i.linearDepthTexture;return t.useProgram(s.program),s.bindPipelineState(t),i.renderDepthDetached((()=>{s.program.bindTexture(a,"depthTex"),this._renderCommon(s.program,e)})),!0}_renderCommon(e,t){if(r(this._vao))return!1;const i=t.rctx;return t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._heightParameters),e.setUniform3fv("cameraPosition",this._cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._projectionInverse),e.setUniformMatrix4fv("viewInverse",this._viewInverse),e.setUniform2fv("nearFar",this._nearFar),e.setUniform2fv("radii",this._radii),e.setUniform1f("scaleHeight",this._scaleHeight),this._simplified||e.setUniform1f("betaMie",R),e.setUniform3fv("betaRayleigh",this._betasRayleigh),e.setUniform3fv("betaCombined",this._betasCombined),e.setUniform1f("innerFadeDistance",this._innerFadeDistance),e.setUniform1f("altitudeFade",this._altitudeFade),e.setUniform1f("skyStrength",this._skyStrength),e.setUniform1f("hazeStrength",this._hazeStrength),e.setUniform1f("mieStrength",this._mieStrength),e.setUniform1f("skyHazeMultiplier",this._skyHazeMultiplier),e.setUniform1f("skyHazePow",this._skyHazePow),e.setUniform1f("sunSize",this._sunSize),e.setUniform1f("sunSpread",this._sunSpread),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateElevation(e){const t=e?e.tile:h(this._view.basemapTerrain.rootTiles,[null])[0];if(r(t)||0!==t.lij[0])return;const i=this._adjustRadiusForTesselation(g.radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(g.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,m(this._radii,e,e+w),this._innerFadeDistance=2*Math.sqrt((2*e-y)*y)}_update(e){if(r(e))return;this._cameraHeight=l(e.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const t=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/w));this._heightParameters=v(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,t),c(this._cameraPosition,e.eye),o(this._projectionInverse,e.projectionMatrix),o(this._viewInverse,e.viewMatrix),m(this._nearFar,e.near,e.far),this._altitudeFade=j(this._cameraHeight-this._lowerBoundEarthRadius)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}export{k as ChapmanAtmosphere};
