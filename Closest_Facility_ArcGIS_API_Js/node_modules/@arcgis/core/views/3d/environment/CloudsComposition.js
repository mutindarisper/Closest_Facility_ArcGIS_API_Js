/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{clamp as a}from"../../../core/mathUtils.js";import{releaseMaybe as s,disposeMaybe as t,isNone as r}from"../../../core/maybe.js";import{b as e,d as i}from"../../../chunks/mat4.js";import{c as o}from"../../../chunks/mat4f64.js";import{z as n,g as d,n as h,a as m,l as c,f as _}from"../../../chunks/vec3.js";import{c as l,f}from"../../../chunks/vec3f64.js";import{create as I,fromPoints as F,axis as u}from"../../../geometry/support/axisAngle.js";import{CloudsCompositionTechnique as P}from"./CloudsCompositionTechnique.js";import{createQuadVAO as O}from"../webgl-engine/lib/glUtil3D.js";var S,g,x;!function(a){a[a.FINISHED=0]="FINISHED",a[a.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",a[a.FADE_IN=2]="FADE_IN"}(S||(S={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.FADE_OUT=1]="FADE_OUT",a[a.FADE_IN=2]="FADE_IN"}(g||(g={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.CROSS_FADE=1]="CROSS_FADE"}(x||(x={}));class p{constructor(a,s,t){this._viewingMode=s,this._inverseProjectionMatrix=o(),this._inverseViewMatrix=o(),this._cameraPositionLastFrame=l(),this._cloudCompositionTechnique=new P({rctx:a,viewingMode:this._viewingMode},null),this._vao=O(a),this._setDefaultParallax(t)}destroy(){this._cloudCompositionTechnique=s(this._cloudCompositionTechnique),this._vao=t(this._vao)}render(a,s){const t=a.camera;if(r(this._vao)||r(t))return!1;const i=a.rctx,o=this._cloudCompositionTechnique.program;return i.useProgram(o),this._cloudCompositionTechnique.bindPipelineState(i),a.scenelightingData.setLightDirectionUniform(o),a.scenelightingData.setUniforms(o),e(this._inverseProjectionMatrix,t.projectionMatrix),e(this._inverseViewMatrix,t.viewMatrix),o.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),o.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),o.bindTexture(s.colorTexture,"cubeMap"),this._setParallaxParams(t.eye),this._bindParallaxParams(o,a.camera),i.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4),!0}isFading(){return this._crossFadeParams.crossFadeStage!==x.FINISHED||this._fadeInOutParams.fadeInOutStage!==g.FINISHED||this._fadeInParams.fadeInStage!==S.FINISHED}_setDefaultParallax(a){this._parallaxParams={anchorPointClouds:l(),radius:a,cloudsFadeOutHeightFactor:0,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:o()},this._parallaxParamsNew={anchorPointClouds:l(),radius:a,cloudsFadeOutHeightFactor:0,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:o()},this._crossFadeParams={crossFadeStage:x.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3},this._fadeInOutParams={fadeInOutStage:g.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6},this._fadeInParams={fadeInStage:S.FINISHED,fadeInFactor:0,distanceThresholdFactor:2}}_isCameraPossitionFinal(a){return n(this._cameraPositionLastFrame,a)}_setFadeInStage(a){const s=this._isCameraPossitionFinal(a);this._fadeInParams.fadeInStage===S.FINISHED&&(this._fadeInParams.fadeInFactor=1,d(this._parallaxParams.anchorPointClouds,N),this._fadeInParams.fadeInStage=S.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=x.FINISHED,this._fadeInOutParams.fadeInOutStage=g.FINISHED),this._fadeInParams.fadeInStage===S.CHANGE_ANCHOR&&s&&(d(this._parallaxParams.anchorPointClouds,N),this._fadeInParams.fadeInStage=S.FADE_IN,this._startTime=performance.now()),this._fadeInParams.fadeInFactor>0&&this._fadeInParams.fadeInStage===S.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500),this._fadeInParams.fadeInFactor<=0&&this._fadeInParams.fadeInStage===S.FADE_IN&&(this._fadeInParams.fadeInStage=S.FINISHED,this._fadeInParams.fadeInFactor=0)}_setCrossFadingStage(){this._crossFadeParams.crossFadeStage===x.FINISHED&&(d(this._parallaxParamsNew.anchorPointClouds,N),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=x.CROSS_FADE),this._crossFadeParams.crossFadeFactor<1&&this._crossFadeParams.crossFadeStage===x.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500),this._crossFadeParams.crossFadeFactor>=1&&this._crossFadeParams.crossFadeStage===x.CROSS_FADE&&(this._crossFadeParams.crossFadeStage=x.FINISHED,this._crossFadeParams.crossFadeFactor=1,d(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds))}_setFadeInOutStage(a){const s=this._isCameraPossitionFinal(a);this._fadeInOutParams.fadeInOutStage===g.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=g.FADE_OUT),this._fadeInOutParams.fadeInOutFactor<1&&this._fadeInOutParams.fadeInOutStage===g.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===g.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,d(this._parallaxParams.anchorPointClouds,N)),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===g.FADE_OUT&&s&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=g.FADE_IN,this._crossFadeParams.crossFadeStage=x.FINISHED,this._crossFadeParams.crossFadeFactor=0),this._fadeInOutParams.fadeInOutFactor>0&&this._fadeInOutParams.fadeInOutStage===g.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500),this._fadeInOutParams.fadeInOutFactor<=0&&this._fadeInOutParams.fadeInOutStage===g.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=g.FINISHED,this._fadeInOutParams.fadeInOutFactor=0)}_setParallaxParams(s){h(N,s),m(N,N,this._parallaxParams.radius),0===this._parallaxParams.anchorPointClouds[0]&&0===this._parallaxParams.anchorPointClouds[1]&&0===this._parallaxParams.anchorPointClouds[2]&&d(this._parallaxParams.anchorPointClouds,N);const t=c(_(E,this._parallaxParams.anchorPointClouds,N));let r=!0;t>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==S.FINISHED?this._setFadeInStage(s):t>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==g.FINISHED?this._setFadeInOutStage(s):t>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._crossFadeParams.crossFadeStage!==x.FINISHED?this._setCrossFadingStage():r=!1;const e=c(s),n=e-this._parallaxParams.radius,l=.05*this._parallaxParams.cloudsHeight,f=.1*this._parallaxParams.cloudsHeight,I=1/(l-f),P=-f/(l-f);this._parallaxParams.cloudsFadeOutHeightFactor=1-a(n*I+P,0,1),this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(e*e-this._parallaxParams.radius*this._parallaxParams.radius,0))/e,F(C,this._parallaxParams.anchorPointClouds,D),this._parallaxParams.transform=o(),i(this._parallaxParams.transform,this._parallaxParams.transform,D[3],u(D)),r&&(F(C,this._parallaxParamsNew.anchorPointClouds,D),this._parallaxParamsNew.transform=o(),i(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,D[3],u(D))),d(this._cameraPositionLastFrame,s)}_bindParallaxParams(s,t){s.setUniform1f("cloudsHeight",this._parallaxParams.cloudsHeight),s.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform),s.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform),s.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds),s.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds),this._fadeInOutParams.fadeInOutStage!==g.FINISHED?s.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(a(this._fadeInOutParams.fadeInOutFactor,0,1))):s.setUniform1f("totalFadeInOut",this._parallaxParams.cloudsFadeOutHeightFactor+Math.max(a(this._fadeInParams.fadeInFactor,0,1))),s.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor),s.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage),s.setUniform1f("crossFadeAnchorFactor",a(this._crossFadeParams.crossFadeFactor,0,1)),s.setUniform1f("radius",this._parallaxParams.radius),s.setUniform3fv("cameraPosition",t.eye)}}const C=f(0,0,1),D=I(),N=l(),E=l();export{p as CloudsComposition};
