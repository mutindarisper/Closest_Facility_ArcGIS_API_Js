/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import"../../../../geometry.js";import t from"../../../../core/Error.js";import{get as i,applySome as r,unwrapOr as a,isNone as s,isSome as n}from"../../../../core/maybe.js";import{px2pt as o,pt2px as l}from"../../../../core/screenUtils.js";import{I as p}from"../../../../chunks/mat4f64.js";import{s as h}from"../../../../chunks/vec4.js";import{f as c}from"../../../../chunks/vec4f64.js";import{create as m,empty as d,expandWithBuffer as y,intersectsClippingArea as u,expandWithAABB as g}from"../../../../geometry/support/aaBoundingBox.js";import{getDriverAxisSizeValueAny as _}from"../../../../renderers/support/renderingInfoUtils.js";import{perVertexElevationAligner as f}from"./ElevationAligners.js";import{SymbolUpdateType as b,elevationModeChangeUpdateType as v,needsElevationUpdates2D as M}from"./elevationAlignmentUtils.js";import{ElevationContext as P}from"./ElevationContext.js";import U from"./Graphics3DDrapedGraphicLayer.js";import{Graphics3DObject3DGraphicLayer as x}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayer as C,getAttributeValue as E}from"./Graphics3DSymbolLayer.js";import{geometryToRenderInfo as L,createGeometry as z,geometryToRenderInfoDraped as D}from"./lineUtils.js";import{initFastSymbolUpdatesState as j,updateFastSymbolUpdatesState as A}from"../support/FastSymbolUpdates.js";import{Object3D as O}from"../../webgl-engine/lib/Object3D.js";import{RenderGeometry as S}from"../../webgl-engine/lib/RenderGeometry.js";import{createStipplePattern as G,scaleStipplePattern as w,getStipplePatternForLinePattern as V}from"../../webgl-engine/materials/lineStippleUtils.js";import{RibbonLineMaterial as R}from"../../webgl-engine/materials/RibbonLineMaterial.js";import F from"../../../../geometry/Extent.js";import T from"../../../../geometry/Polygon.js";const I=["polyline","polygon","extent"];class k extends C{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=j(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:o(1);if(e<0)throw new t("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}getMaterialParameters(t){const s=i(this.symbolLayer,"material","color"),n=this._getCombinedOpacityAndColor(s);this._patternHidesLine&&(n[3]=0);const p=n[3],h={width:1,color:n,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:p<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:t,stipplePattern:r(a(this.symbolLayer.stipplePattern,(()=>w(V(this.symbolLayer.pattern),this.symbolLayer.size))),(e=>G(e.map(l)))),stippleOffColor:this.symbolLayer.stippleOffColor?e.toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(h.width=l(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:o(1);h.width=l(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...h,...this._fastUpdates.materialParameters}:h}get lineMaterial(){return s(this._lineMaterial)&&(this._lineMaterial=new R(this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return s(this._ringMaterial)&&(this._ringMaterial=new R(this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null}getDrivenSize(e){return this._drivenProperties.size&&e.size?l(_(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?E(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const t=c(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?E(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?E(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,I,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new P);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return!1;if(!A(this._fastUpdates,t,this._vvConvertOptions))return!1;n(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),n(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters)}return!0}layerOpacityChanged(){return n(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),n(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(e){const t=e.params.color,r=i(this.symbolLayer,"material","color"),a=this._patternHidesLine?0:this._getCombinedOpacity(r),s=a<1||this.needsDrivenTransparentPass,n=[t[0],t[1],t[2],a];e.setParameterValues({color:n,transparent:s})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=v(k.elevationModeChangeTypes,i,r);if(a!==b.UPDATE)return a;const s=M(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){return n(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),n(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof F)return T.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const r=e.graphic,a=this._getGeometryAsPolygonOrPolyline(r.geometry),s="polygon"===a.type?a.rings:a.paths,o=new Array,l=new Array,h=new Array,c=m(),g=L(a,this._context.elevationProvider,this._context.renderCoordsHelper,t),_="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(g,s,_,"LineSymbol3DLayer");for(let m=0;m<g.lines.length;m++){const{position:t,mapPosition:i}=g.lines[m];if(n(this._context.clippingExtent)&&(d(c),y(c,i),!u(c,this._context.clippingExtent)))continue;const r=this._createGeometry(e,t,i,a.type);o.push(r),l.push("polygon"===a.type?this.ringMaterial:this.lineMaterial),h.push(p)}if(0===o.length)return null;const b=new O({geometries:o,materials:l,transformations:h,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),v=new x(this,b,o,null,null,f,t);return v.alignedSampledElevation=g.sampledElevation,v.needsElevationUpdates=M(t.mode),v}_createGeometry(e,t,i,r){const a="polygon"===r?1:0,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return z({removeDuplicateStartEnd:a,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:n?null:this.getDrivenSize(e.renderingInfo),color:s?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),a="polygon"===r.type?r.rings:r.paths,s="polygon"===r.type?this.ringMaterial:this.lineMaterial;s.renderPriority=this._renderPriority;const n=new Array,o=m(),l=d(),p=D(r,this._context.overlaySR),c="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(p,a,c,"LineSymbol3DLayer");for(const m of p.lines){if(d(o),y(o,m.position),!u(o,this._context.clippingExtent))continue;g(l,o);const a=this._createGeometry(e,m.position,null,r.type),p=new S(a,s,t,i.uid);h(p.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),n.push(p)}return new U(this,n,l)}get _patternHidesLine(){return"none"===this.symbolLayer.pattern}}k.elevationModeChangeTypes={definedChanged:b.RECREATE,staysOnTheGround:b.NONE,onTheGroundChanged:b.RECREATE};export{k as Graphics3DLineSymbolLayer,k as default};
