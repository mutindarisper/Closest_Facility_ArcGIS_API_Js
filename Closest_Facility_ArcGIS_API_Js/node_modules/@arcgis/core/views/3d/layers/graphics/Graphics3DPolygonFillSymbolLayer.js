/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import{isSome as t,get as i,isNone as r,unwrap as n,mapOr as o}from"../../../../core/maybe.js";import{pt2px as a}from"../../../../core/screenUtils.js";import{e as s}from"../../../../chunks/earcut.js";import{I as l}from"../../../../chunks/mat4f64.js";import{s as u}from"../../../../chunks/vec4.js";import{create as p,empty as c,expandWithBuffer as h,intersectsClippingArea as m,expandWithAABB as d}from"../../../../geometry/support/aaBoundingBox.js";import{BufferViewMat3f64 as _,BufferViewVec3f64 as y,BufferViewVec4f as g}from"../../../../geometry/support/buffer/BufferView.js";import{SymbolUpdateType as f,elevationModeChangeUpdateType as b,needsElevationUpdates2D as M}from"./elevationAlignmentUtils.js";import{ElevationContext as E}from"./ElevationContext.js";import v from"./Graphics3DDrapedGraphicLayer.js";import{Graphics3DObject3DGraphicLayer as x}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayer as O}from"./Graphics3DSymbolLayer.js";import{mixinColorAndOpacity as D}from"./graphicUtils.js";import{createGeometry as A}from"./lineUtils.js";import{geometryAsPolygon as S,geometryToRenderInfo as P,createColorGeometry as C,geometryToRenderInfoDraped as U}from"./polygonUtils.js";import{createMaterial as G,uvElevationAligner as w}from"../support/patternUtils.js";import{createMapSpaceUVCoords as j,createMapSpaceUVCoordsDraped as T}from"../support/uvUtils.js";import{Object3D as R}from"../../webgl-engine/lib/Object3D.js";import{RenderGeometry as B}from"../../webgl-engine/lib/RenderGeometry.js";import{createStipplePattern as L,scaleStipplePattern as N,getStipplePatternForLinePattern as V}from"../../webgl-engine/materials/lineStippleUtils.js";import{NativeLineMaterial as F}from"../../webgl-engine/materials/NativeLineMaterial.js";import{PatternMaterial as I}from"../../webgl-engine/materials/PatternMaterial.js";import{RibbonLineMaterial as z}from"../../webgl-engine/materials/RibbonLineMaterial.js";const k=["polyline","polygon","extent"];class Y extends O{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(t(this._material))return;const e=i(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e);this._material=G(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof I,this._context.stage.add(this._material)}ensureOutlineMaterial(){const i=this.symbolLayer.outline;if(t(this._outlineMaterial)||!this._isValidOutline(i))return;this._hasOutline=!0;const r=t=>{const r=o(i.stipplePattern,N(V(i.pattern),a(i.size)),(e=>L(e.map(a)))),n=i.stippleOffColor?e.toUnitRGBA(i.stippleOffColor):null;return t>1.5?new z({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:n,cap:i.patternCap||"butt"}):new F({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:r,stippleIntegerRepeats:!0,stippleOffColor:n})};this._outlineMaterial=r(a(i.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return t(e)&&e.size&&e.size>0&&t(e.color)&&"none"!==e.pattern}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,k,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new E);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(t(this._material)){const e=this._material.params.color,t=i(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(t(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=b(Y.elevationModeChangeTypes,i,r);if(n!==f.UPDATE)return n;const o=M(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>o))}slicePlaneEnabledChanged(){if(t(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),t(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const n=S(e.geometry);if(r(n))return null;H.renderData=P(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),H.color=t;const o=H.renderData.position.length/3;if(this._needsUV&&(H.uvMapSpace=new Float32Array(4*o),H.boundingRect=new Float64Array(9*o)),H.outNum=0,H.outGeometries=[],H.outTransforms=[],H.outMaterials=[],this._createAs3DShapeFill(H),this._hasOutline&&this._createAs3DShapeOutline(H),this._logGeometryCreationWarnings(H.renderData,n.rings,"rings","FillSymbol3DLayer"),0===H.outNum)return null;this._needsUV&&j(g.fromTypedArray(H.uvMapSpace),y.fromTypedArray(H.renderData.position),this._context.renderCoordsHelper,_.fromTypedArray(H.boundingRect));const a=new R({geometries:H.outGeometries,materials:H.outMaterials,transformations:H.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),s=w,l=new x(this,a,H.outGeometries,null,null,s,i);return l.alignedSampledElevation=H.renderData.sampledElevation,l.needsElevationUpdates=M(i.mode),l}_createAs3DShapeFill(e){const i=e.renderData.polygons;for(const{position:r,mapPosition:o,holeIndices:a,index:u,count:p}of i){if(t(this._context.clippingExtent)&&(c(q),h(q,o),!m(q,this._context.clippingExtent)))continue;const i=s(o,a,3);if(0===i.length)continue;const d=new Uint32Array(i),_=C({indices:d,attributeData:{position:r,color:e.color,mapPosition:o,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*u*e.uvMapSpace.BYTES_PER_ELEMENT,4*p):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*u*e.boundingRect.BYTES_PER_ELEMENT,9*p):null}});e.outGeometries.push(_),e.outMaterials.push(n(this._material)),e.outTransforms.push(l),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const i=e.renderData.outlines,r=this._outlineMaterial instanceof F;for(let o=0;o<i.length;++o){const{mapPosition:a,position:s}=i[o];if(t(this._context.clippingExtent)&&(c(q),h(q,a),!m(q,this._context.clippingExtent)))continue;const u=A({removeDuplicateStartEnd:r?0:1,attributeData:{position:s,mapPosition:a}}),p=u.vertexAttributes.get("position");p.data===s&&(p.data=new Float64Array(s)),e.outGeometries.push(u),e.outMaterials.push(n(this._outlineMaterial)),e.outTransforms.push(l),e.outNum++}}_createAsOverlay(e,i){const o=S(e.geometry);if(r(o))return null;n(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,t(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),W.renderData=U(o,this._context.overlaySR),W.color=i;const a=W.renderData.position.length/3;return this._needsUV&&(W.uvMapSpace=new Float32Array(4*a)),W.outNum=0,W.outGeometries=[],W.outBoundingBox=c(),W.layerUid=this._context.layer.uid,W.graphicsUid=e.uid,this._createAsOverlayFill(W),this._hasOutline&&this._createAsOverlayOutline(W),this._logGeometryCreationWarnings(W.renderData,o.rings,"rings","FillSymbol3DLayer"),0===W.outNum?null:(this._needsUV&&T(g.fromTypedArray(W.uvMapSpace),y.fromTypedArray(W.renderData.position),this._context.overlaySR),W.outNum>0?new v(this,W.outGeometries,W.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:o,count:a}of t){if(c(q),h(q,i),!m(q,this._context.clippingExtent))continue;const t=s(i,r,3);if(0===t.length)continue;d(e.outBoundingBox,q);const l=new Uint32Array(t),p=C({indices:l,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*o*e.uvMapSpace.BYTES_PER_ELEMENT,4*a):null}}),_=new B(p,n(this._material),e.layerUid,e.graphicsUid),y=q;u(_.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(_),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(c(q),h(q,r),!m(q,this._context.clippingExtent))continue;d(e.outBoundingBox,q);const o=this._outlineMaterial instanceof F,a=A({removeDuplicateStartEnd:o?0:1,attributeData:{position:r}}),s=new B(a,n(this._outlineMaterial),e.layerUid,e.graphicsUid),l=q;u(s.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),e.outGeometries.push(s),e.outNum++}}_getOutlineOpacity(){const e=i(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(t(e)?e.a:0)}_getOutlineColor(){const r=i(this.symbolLayer,"outline","color"),n=this._getOutlineOpacity();return D(t(r)?e.toUnitRGB(r):null,n)}get test(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}Y.elevationModeChangeTypes={definedChanged:f.RECREATE,staysOnTheGround:f.NONE,onTheGroundChanged:f.RECREATE};const q=p(),H={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},W={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};export{Y as Graphics3DPolygonFillSymbolLayer,Y as default};
