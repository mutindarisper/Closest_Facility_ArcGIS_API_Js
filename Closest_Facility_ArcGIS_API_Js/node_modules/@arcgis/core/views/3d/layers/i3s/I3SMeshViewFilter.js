/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import"../../../../geometry.js";import t from"../../../../core/Accessor.js";import{PositionHint as r,indexOf as s}from"../../../../core/arrayUtils.js";import n from"../../../../core/Logger.js";import{isNone as i,isSome as o}from"../../../../core/maybe.js";import{getUnitString as a}from"../../../../core/unitUtils.js";import{whenOnce as c}from"../../../../core/watchUtils.js";import{property as l}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as p}from"../../../../core/accessorSupport/decorators/subclass.js";import{t as u,b as f,s as d}from"../../../../chunks/vec3.js";import{WhereClause as g}from"../../../../core/sql/WhereClause.js";import{projectBoundingSphere as h,load as y,project as m,projectVectorToVector as j}from"../../../../geometry/projection.js";import{create as b}from"../../../../geometry/support/aaBoundingBox.js";import{fromValues as S,expandWithNestedArray as R,expand as w}from"../../../../geometry/support/aaBoundingRect.js";import{project as F}from"../../../../geometry/support/webMercatorUtils.js";import{objectIdFilter as E,filterInPlace as I}from"./I3SUtil.js";import x from"../../../layers/support/FeatureFilter.js";import M from"../../../../geometry/SpatialReference.js";const _=n.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let v,O=class extends t{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){c(this,"filter.geometry").then((()=>this.loadAsyncModule(G().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if(i(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=o(this.filter)?this.filter.where:null;if(i(e)||!e)return null;try{return g.create(e,this.layerFieldsIndex)}catch(t){_.error(`Failed to parse filter where clause: ${t}`)}return null}addFilters(e,t,r,s){const n=this.sortedObjectIds;o(n)&&e.push((e=>E(n,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const i=this.parsedGeometry;if(o(i)){const n=this.spatialRelationship;e.push(((e,o)=>A(e,o,s,t,r,i,n)))}}isMBSGeoemtryVisible(e,t,r){const s=this.parsedGeometry;if(o(s)){const n=this.spatialRelationship,i=s[0].spatialReference||t;if(!h(e,r,T,i))return _.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0;return C(T,s,i,n)}return!0}get parsedGeometry(){if(i(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if(i(e))return null;const{distance:t,units:r}=this.filter,s=this.spatialRelationship,n="mesh"===e.type?e.extent:e;if(i(t)||0===t)return L(n,s);const c=r||a(n.spatialReference);if(n.spatialReference.isWGS84){return L(this._geometryEngine.geodesicBuffer(n,t,c),s)}const l=F(n,M.WGS84);if(o(l)){return L(F(this._geometryEngine.geodesicBuffer(l,t,c),n.spatialReference),s)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(y().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let p=null;try{p=m(n,M.WGS84)}catch(u){}if(p)try{p=m(this._geometryEngine.geodesicBuffer(p,t,c),n.spatialReference)}catch(u){p=null}return p||_.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${n.spatialReference.wkid}) to WGS84.`),L(p,s)}get spatialRelationship(){return o(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(_.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!B(e.spatialRelationship)||(_.warn(`Filters with spatialRelationship other than ${W.join(", ")} are not supported for mesh scene layers`),!1)}};function k(){return!!v}async function G(){return k()||(v=await import("../../../../geometry/geometryEngine.js")),v}e([l({type:x})],O.prototype,"filter",void 0),e([l()],O.prototype,"layerFieldsIndex",void 0),e([l()],O.prototype,"loadAsyncModule",void 0),e([l()],O.prototype,"applyFilters",void 0),e([l()],O.prototype,"addSqlFilter",void 0),e([l({readOnly:!0})],O.prototype,"sortedObjectIds",null),e([l({readOnly:!0})],O.prototype,"parsedWhereClause",null),e([l({readOnly:!0})],O.prototype,"parsedGeometry",null),e([l({readOnly:!0})],O.prototype,"spatialRelationship",null),e([l()],O.prototype,"_projectionEngineLoaded",void 0),e([l()],O.prototype,"_geometryEngine",void 0),O=e([p("esri.views.3d.layers.i3s.I3SMeshViewFilter")],O);const W=(e=>e)(["contains","intersects","disjoint"]);function B(e){return null!=e&&W.indexOf(e)>=0}function L(e,t){if(i(e))return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let r=0;r<e.rings.length;++r){const s=S(1/0,1/0,-1/0,-1/0);R(s,e.rings[r]),t[r]={type:"polygon",rings:[e.rings[r]],spatialReference:e.spatialReference,aabr:s}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const n=new Set,i=new r;for(let e=0;e<t.length;++e){const r=t[e];for(let s=e+1;s<t.length;++s){const e=t[s];if(e.aabr[0]>=r.aabr[2])break;n.add(e)}n.forEach((e=>{if(r!==e)if(e.aabr[2]<=r.aabr[0])n.delete(e);else if(v.intersects(r,e)){r.rings=r.rings.concat(e.rings),w(r.aabr,e.aabr,r.aabr),delete r._geVersion,n.delete(e);const o=s(t,e,t.length,i);t.splice(o,1)}})),n.add(r)}for(const e of t)delete e.aabr;return t}return[e]}function C(e,t,r,s){const n=U(e,r);return t.every((e=>1!==q(e,n,s)))}function A(e,t,r,s,n,i,o){const a=i[0].spatialReference||s.spatialReference;if(!h(t.node.mbs,n,T,a))return void _.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=U(T,a),l=V(o,s,a,r,t.objectHandle);for(const p of i){if(0===e.length)return;switch(q(p,c,o)){case 1:return void(e.length=0);case 0:continue}I(e,t.featureIds,(e=>H(p,e,l)))}}const T=[0,0,0,0];function V(e,t,r,s,n){const i=t.renderSpatialReference,o=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const c={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let l,p;switch(e){case"intersects":l=(e,t)=>v.intersects(e,t)?0:2,p=Z;break;case"contains":l=(e,t)=>v.contains(e,t)?2:1,p=Z;break;default:l=(e,t)=>v.disjoint(e,t)?2:1,p=$}return{collection:s,object:n,type:e,maskSR:r,renderSR:i,aabbCache:o,triangle:a,positions:c,triangleTest:l,geometryTest:p}}function U(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},s=!t.isWGS84&&!t.isWebMercator?v.buffer(r,e[3],1):v.geodesicBuffer(r,e[3],1);return s.type="polygon",s}function q(e,t,r){switch(r){case"intersects":case"contains":return Z(e,t);case"disjoint":return $(e,t)}}function Z(e,t){return v.intersects(e,t)?v.contains(e,t)?0:2:1}function $(e,t){return v.intersects(e,t)?v.contains(e,t)?1:2:0}const z=2**-32;function H(e,t,r){const{collection:s,object:n,renderSR:i,maskSR:o,geometryTest:a,aabbCache:c}=r;let l=c.get(t);if(!l){const e=s.getObjectTransform(n);s.getComponentAabb(n,t,P);const r=[[P[0],P[1],0],[P[0],P[4],0],[P[3],P[4],0],[P[3],P[1],0]];for(let t=0;t<4;++t)u(r[t],r[t],e.rotationScale),f(r[t],r[t],e.position),j(r[t],i,r[t],o);l={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:o},l.rings[0][4]=l.rings[0][0],c.set(t,l)}switch(a(e,l)){case 1:return!1;case 0:return!0}const{triangle:p,triangleTest:g,positions:h}=r,y=p.rings[0][0],m=p.rings[0][1],b=p.rings[0][2],S=s.getObjectTransform(n);s.getComponentPositions(n,t,h);const{indices:R,data:w,stride:F,startIndex:E,endIndex:I}=h;for(let x=E;x<I;x+=3){const t=F*R[x+0],r=F*R[x+1],s=F*R[x+2];d(y,w[t+0],w[t+1],w[t+2]),d(m,w[r+0],w[r+1],w[r+2]),d(b,w[s+0],w[s+1],w[s+2]),u(y,y,S.rotationScale),u(m,m,S.rotationScale),u(b,b,S.rotationScale),f(y,y,S.position),f(m,m,S.position),f(b,b,S.position),j(y,i,y,o),j(m,i,m,o),j(b,i,b,o);const n=m[0]-y[0],a=m[1]-y[1],c=b[0]-y[0],l=b[1]-y[1];if(!(Math.abs(n*l-a*c)<z))switch(delete p._geVersion,g(e,p)){case 1:return!1;case 0:return!0}}return"intersects"!==r.type}const P=b();export{O as I3SMeshViewFilter};
