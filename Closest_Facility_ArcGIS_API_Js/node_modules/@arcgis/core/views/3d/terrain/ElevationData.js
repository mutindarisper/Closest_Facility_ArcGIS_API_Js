/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{clamp as t}from"../../../core/mathUtils.js";import{bilerp as a}from"../support/mathUtils.js";import{ELEVATION_NODATA_VALUE as s}from"./TerrainConst.js";class i{constructor(t,a,s){this.type="elevation",this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=a;const i=s.noDataValue,e=s.values;let o=1/0,l=-1/0,h=!0,r=!1;for(let n=0;n<e.length;n++){const t=e[n];t!==i?(o=t<o?t:o,l=t>l?t:l,h=!1):r=!0}h&&(o=0,l=0),l=l>-3e38?l:0,this.samplerData={pixelData:s.values,width:s.width,height:s.height,noDataValue:i,safeWidth:.99999999*(s.width-1),dx:(s.width-1)/(a[2]-a[0]),dy:(s.width-1)/(a[3]-a[1]),x0:a[0],y1:a[3]},this.bounds=[o,l],this.hasNoDataValues=r}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,i,e,o){o.min=1/0,o.max=-1/0,o.hasNoDataValues=!1;const l=t-this.level;if(l<=0)return o;const h=2**l;if(!(Math.floor(i/h)===this.i&&Math.floor(e/h)===this.j))return o;let r=1/0,n=-1/0;const m=this.samplerData.width,f=this.samplerData.pixelData,u=.5*s;let c=(m-1)/h,p=(e-this.j*h)*c,d=(i-this.i*h)*c;if(c<1){const t=Math.floor(p),s=Math.floor(d),i=t+s*m,e=f[i],l=f[i+1],h=f[i+m],r=f[i+m+1];if(e+l+h+r<u){const i=p-t,n=d-s,m=a(e,l,h,r,i,n),f=a(e,l,h,r,i+c,n),u=a(e,l,h,r,i,n+c),x=a(e,l,h,r,i+c,n+c);return o.min=Math.min(m,f,u,x),o.max=Math.max(m,f,u,x),o}p=t,d=s,c=1}else p=Math.floor(p),d=Math.floor(d),c=Math.ceil(c);for(let a=p;a<=p+c;a++)for(let t=d;t<=d+c;t++){const s=f[a+t*m];s<u?(r=Math.min(r,s),n=Math.max(n,s)):o.hasNoDataValues=!0}return o.min=r,o.max=n,o}static sample(a,i,e){for(const o of e){if(!o)continue;const e=o.safeWidth,l=o.width,h=o.pixelData;let r=t(o.dy*(o.y1-i),0,e),n=t(o.dx*(a-o.x0),0,e);const m=Math.floor(r),f=Math.floor(n),u=m*l+f,c=u+l,p=h[u],d=h[c],x=h[u+1],M=h[c+1];if(p+d+x+M<.5*s){r-=m,n-=f;const t=p+(x-p)*n;return t+(d+(M-d)*n-t)*r}}return null}}export{i as ElevationData};
