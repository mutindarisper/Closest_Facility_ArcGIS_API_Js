/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{deg2rad as t,floatEqualAbsolute as i,floatEqualRelative as s}from"../../../core/mathUtils.js";import{isNone as r,isSome as l}from"../../../core/maybe.js";import{getMetersPerUnitForSR as o}from"../../../core/unitUtils.js";import n from"../../../geometry/Extent.js";import{canProjectToWGS84ComparableLonLat as a}from"../../../geometry/projection.js";import h from"../../../geometry/SpatialReference.js";import{create as c}from"../../../geometry/support/aaBoundingRect.js";import{isMars as u,isMoon as m}from"../../../geometry/support/spatialReferenceUtils.js";import{x2lon as p,y2lat as f}from"../../../geometry/support/webMercatorUtils.js";import g from"../../../layers/support/TileInfo.js";const x=12;class v{constructor(e){const t=v.checkUnsupported(e);if(t)throw t;this.spatialReference=e.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=a(this.spatialReference)||u(this.spatialReference)||m(this.spatialReference),this.origin=[e.origin.x,e.origin.y],this.pixelSize=e.size[0],this.dpi=e.dpi;const i=e.lods.reduce((function(e,t,i){return t.level<e.min&&(e.min=t.level,e.minIndex=i),e.max=Math.max(e.max,t.level),e}),{min:1/0,minIndex:0,max:-1/0}),s=e.lods[i.minIndex],r=2**s.level;let l=s.resolution*r,o=s.scale*r;this.levels=new Array(i.max+1);for(let n=0;n<this.levels.length;n++)this.levels[n]={resolution:l,scale:o,tileSize:[l*e.size[0],l*e.size[1]]},l/=2,o/=2}clone(){return new v(this.toTileInfo())}toTileInfo(){return new g({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,s){const r=this.levels[e],l=r.tileSize[0],o=r.tileSize[1];s[0]=this.origin[0]+i*l,s[2]=s[0]+l,s[3]=this.origin[1]-t*o,s[1]=s[3]-o}convertExtentToRadians(e,i){this._isWebMercator?(i[0]=p(e[0]),i[1]=f(e[1]),i[2]=p(e[2]),i[3]=f(e[3])):this._isGCS&&(i[0]=t(e[0]),i[1]=t(e[1]),i[2]=t(e[2]),i[3]=t(e[3]))}getExtentGeometry(e,t,i,s=new n){return this.getExtent(e,t,i,M),s.spatialReference=this.spatialReference,s.xmin=M[0],s.ymin=M[1],s.xmax=M[2],s.ymax=M[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const e=this.levels[this.levels.length-1],i=e.resolution/2;this.levels.push({resolution:i,scale:e.scale/2,tileSize:[i*this.pixelSize,i*this.pixelSize]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof v)){if(v.checkUnsupported(e))return!1;e=new v(e)}if(!e.spatialReference.equals(this.spatialReference))return!1;if(e.pixelSize!==this.pixelSize)return!1;const t=Math.min(this.levels.length,e.levels.length)-1,s=this.levels[t].resolution;let r=.5*s;if(!i(e.origin[0],this.origin[0],r)||!i(e.origin[1],this.origin[1],r))return!1;return r=.5*s/2**t/this.pixelSize*x,i(s,e.levels[t].resolution,r)}rootTilesInExtent(e,t=null,i=1/0){const s=new Array,o=this.levels[0].tileSize;if(r(e)||0===o[0]||0===o[1])return s;v.computeRowColExtent(e,o,this.origin,M);let n=M[1],a=M[3],h=M[0],c=M[2];const u=c-h,m=a-n;if(u*m>i){const e=Math.floor(Math.sqrt(i));m>e&&(n=n+Math.floor(.5*m)-Math.floor(.5*e),a=n+e),u>e&&(h=h+Math.floor(.5*u)-Math.floor(.5*e),c=h+e)}for(let r=n;r<a;r++)for(let e=h;e<c;e++)s.push([0,r,e]);return l(t)&&(t[0]=this.origin[0]+h*o[0],t[1]=this.origin[1]-a*o[1],t[2]=this.origin[0]+c*o[0],t[3]=this.origin[1]-n*o[1]),s}static computeRowColExtent(e,t,i,s){const r=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+r-i[0])/t[0])),s[2]=Math.max(0,Math.ceil((e[2]-r-i[0])/t[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+r)/t[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-r)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((function(e){return!s(e.resolution,i/2**e.level)}))}static hasGapInLevels(e){const t=e.lods.map((function(e){return e.level}));t.sort((function(e,t){return e-t}));for(let i=1;i<t.length;i++)if(t[i]!==t[0]+i)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&0==(t&t-1)&&t>=128&&t<=512}static checkUnsupported(t){return t?t.lods.length<1?new e("tilingscheme:generic","Tiling scheme must have at least one level"):v.isPowerOfTwo(t)?v.hasGapInLevels(t)?new e("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):v.tileSizeSupported(t)?null:new e("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new e("tilingscheme:power-of-two","Tiling scheme must be power of two"):new e("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static fromExtent(e,t){const i=e[2]-e[0],s=e[3]-e[1],r=o(t),l=1.2*Math.max(i,s),n=256,a=96,h=.0254,c=new v(new g({size:[n,n],origin:{x:e[0]-.5*(l-i),y:e[3]+.5*(l-s)},lods:[{level:0,resolution:l/n,scale:1/(n/a*h/(l*r))}],spatialReference:t}));return c.ensureMaxLod(20),c}static makeWebMercatorAuxiliarySphere(e){const t=new v(v.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const s=256/t,r=new v(new g({size:[t,t],origin:{x:-180,y:90,spatialReference:e},spatialReference:e,lods:[{level:0,resolution:.703125*s,scale:295497598.570834*s}]}));return r.ensureMaxLod(i),r}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}v.WebMercatorAuxiliarySphereTileInfo=new g({size:[256,256],origin:{x:-20037508.342787,y:20037508.342787,spatialReference:h.WebMercator},spatialReference:h.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]}),v.WebMercatorAuxiliarySphere=v.makeWebMercatorAuxiliarySphere(19);const M=c();export{v as default};
