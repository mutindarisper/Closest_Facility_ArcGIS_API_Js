/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import i from"../../../core/Handles.js";import{destroyMaybe as s,isSome as r}from"../../../core/maybe.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/Logger.js";import{subclass as n}from"../../../core/accessorSupport/decorators/subclass.js";import{canProjectToWGS84ComparableLonLat as l}from"../../../geometry/projection.js";import{equals as h}from"../../../geometry/support/aaBoundingRect.js";import{isMars as c,isMoon as a}from"../../../geometry/support/spatialReferenceUtils.js";import{isTiledLayer as p}from"../../../layers/support/layerUtils.js";import{getTiledLayerInfo as d,isVectorTileLayer as m,isProjectableRasterLayer as g}from"./terrainUtils.js";import S from"./TilingScheme.js";let y=class extends t{constructor(e){super(e),this._handles=new i}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=s(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some((t=>!(!p(t)||t.isRejected())&&(!(t.isFulfilled()&&!u(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!m(t)&&!g(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=d(t,this.viewSpatialReference,this.viewingMode),s=new S(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(s)}else this._updateWhen(e);else this._set("tilingSchemeDone",!0)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(1===this.viewingMode){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=S.makeWebMercatorAuxiliarySphere(t):l(e.spatialReference)&&(e=S.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(1===this.viewingMode){const e=this.extentHelper.viewSpatialReference,t=l(e)||c(e)||a(e);e.isWebMercator?this.tilingScheme=S.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=S.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;r(e)&&!h(e,this.extent)&&(this.tilingScheme=S.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function u(e,t,i){return!!d(e,t,i).tileInfo}e([o()],y.prototype,"tilingScheme",void 0),e([o({readOnly:!0})],y.prototype,"extent",void 0),e([o({value:!1})],y.prototype,"tilingSchemeLocked",void 0),e([o({readOnly:!0,value:!1})],y.prototype,"tilingSchemeDone",void 0),e([o({constructOnly:!0})],y.prototype,"viewSpatialReference",void 0),e([o({constructOnly:!0})],y.prototype,"layers",void 0),e([o({constructOnly:!0})],y.prototype,"extentHelper",void 0),e([o({constructOnly:!0})],y.prototype,"viewingMode",void 0),y=e([n("esri.views.3d.terrain.TilingSchemeLogic")],y);export{y as TilingSchemeLogic};
