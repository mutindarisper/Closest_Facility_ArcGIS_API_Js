/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{unwrap as e}from"../../../../../core/maybe.js";import t from"../../../../../core/PooledArray.js";class s{constructor(e,s,r=0){this._rctx=e,this._techniqueRepository=s,this._sorting=r,this._draws=new t({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(t,s,r,i,a){const n=this._draws.pushNew();n.geometry=s,n.geometryRanges=r,n.material=t,n.bindDrawParams=i,n.depthSquaredHint=a,n.indexType=s.indexed?e(s.vao.indexBuffer).indexType:0}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let s=null;const i=this._draws.length;for(let a=0;a<i;a++){const i=this._draws.data[a],n=i.geometry,o=i.material.getTechnique(this._techniqueRepository,e,n.parameters);o===s&&3===o.configuration.transparencyPassType||(t.useProgram(o.program),t.setPipelineState(o.pipeline),s=o),this._passBoundTechniques.has(o)||(o.bindPass(e),this._passBoundTechniques.add(o)),t.bindVAO(n.vao),this._previouslyBoundMaterials.get(o)!==i.material&&(o.bindMaterial(i.material,e),this._previouslyBoundMaterials.set(o,i.material)),this._previouslyBoundDraw.get(o)!==i.bindDrawParams&&(o.bindDraw(i.bindDrawParams,i.material,e),this._previouslyBoundDraw.set(o,i.bindDrawParams));const d=i.geometryRanges,l=d.length;if(0!==i.indexType){const e=r.get(i.indexType);for(let s=0;s<l;s+=2){const r=d[s],a=d[s+1];t.drawElements(n.primitiveType,a,i.indexType,r*e)}}else for(let e=0;e<l;e+=2){const s=d[e],r=d[e+1];t.drawArrays(n.primitiveType,s,r)}}return i>0}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,s)=>{const r=e*(t.depthSquaredHint-s.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-s.geometry.vao.size}))}get count(){return this._draws.length}}const r=new Map;r.set(5121,1),r.set(5123,2),r.set(5125,4);export{s as RenderPass};
