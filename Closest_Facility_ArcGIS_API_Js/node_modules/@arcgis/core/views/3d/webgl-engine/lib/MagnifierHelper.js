/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import s from"../../../../core/Accessor.js";import r from"../../../../core/Evented.js";import t from"../../../../core/Handles.js";import{clamp as i}from"../../../../core/mathUtils.js";import{isNone as o,isSome as a}from"../../../../core/maybe.js";import{createTask as n}from"../../../../core/promiseUtils.js";import{createScreenPointArray as m,createRenderScreenPointArray as u,screenPointObjectToArray as l}from"../../../../core/screenUtils.js";import{isSVG as p}from"../../../../core/urlUtils.js";import{property as c}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/Logger.js";import{subclass as h}from"../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as d}from"../../../../support/requestImageUtils.js";import"../../../webgl/BufferObject.js";import"../../../webgl/FramebufferObject.js";import"../../../webgl/checkWebGLError.js";import"../../../webgl/enums.js";import"../../../../chunks/builtins.js";import{makePipelineState as g,simpleBlendingParams as f,defaultColorWriteParams as _}from"../../../webgl/renderState.js";import k from"../../../webgl/Texture.js";import"../../../webgl/VertexArrayObject.js";import{Pos2 as b}from"./DefaultVertexBufferLayouts.js";import{createQuadVAO as v}from"./glUtil3D.js";import{Program as y}from"./Program.js";import{testWebGLDriver as T}from"./WebGLDriverTest.js";import{build as j}from"../shaders/Magnifier.glsl.js";import{loadMagnifierResources as x}from"../../../magnifier/resources.js";let w=class extends s{constructor(){super(...arguments),this._handles=new t,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new r,this.attributeLocations=new Map([["position",0]]),this.tmpScreenPoint=m(),this.tmpRenderPoint=u()}get updating(){return o(this._imageSources)&&a(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const s=()=>{this.updateResourceLoading(),this.events.emit("request-render")};a(this._magnifier)&&this._handles.add(this._magnifier.watch("version",s)),s()}get enabled(){return a(this._validMagnifier)}get _validMagnifier(){return a(this._magnifier)&&this._magnifier.visible&&a(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return a(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),a(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(e,s){const r=this._validMagnifier;if(o(r))return;const t=s.camera.pixelRatio,a=Math.ceil(t*r.size);if(this.updateResources(e,a),o(this._resources))return;const n=this._resources.program;e.useProgram(n);const m=this._resources.textures,u=Math.ceil(1/this.factor*a);m.input.resize(u,u);const p=s.camera.fullWidth,c=s.camera.fullHeight;l(r.position,this.tmpScreenPoint);const h=s.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),d=.5*u,g=.5*u;h[0]=i(h[0],d,p-d-1),h[1]=i(h[1],g,c-g-1);const f=Math.floor(h[0]-d),_=Math.floor(h[1]-g);n.bindTexture(m.input,"textureInput"),e.gl.copyTexImage2D(m.input.descriptor.target,0,m.input.descriptor.pixelFormat,f,_,u,u,0);const k=r.offset.x*t,b=r.offset.y*t,v=(h[0]+k)/p*2-1,y=(h[1]-b)/c*2-1,T=a/p*2,j=a/c*2;e.bindVAO(this._resources.vao),n.bindTexture(m.overlay,"textureOverlay"),n.bindTexture(m.mask,"textureMask"),n.setUniform4f("drawPosition",v,y,T,j),n.setUniform1i("maskEnabled",r.maskEnabled?1:0),n.setUniform1i("overlayEnabled",r.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)}updateResourceLoading(){const e=this._validMagnifier;if(o(e))return;const s=e.maskUrl,r=e.overlayUrl;!a(this._imageLoadTask)||this._imageLoadTask.maskUrl===s&&this._imageLoadTask.overlayUrl===r||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),a(this._imageSources)||a(this._imageLoadTask)||(this._imageLoadTask={maskUrl:s,overlayUrl:r,task:n((async e=>{const t=o(s)||o(r)?x(e):null,i=a(s)?d(s,{signal:e}):t.then((e=>e.mask)),n=a(r)?d(r,{signal:e}):t.then((e=>e.overlay));this._imageSources={mask:await i,overlay:await n},this.disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}updateResources(e,s){if(!this.enabled)return void this.disposeResources();if(a(this._resources)){if(this._resources.textures.size!==s){const r=this.createTextureResources(e,s);if(o(r))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=r}return}const r=this.createTextureResources(e,s);o(r)||(this._resources={textures:r,program:this.createProgram(e),vao:v(e,b,this.attributeLocations,0,1),pipelineState:g({blending:f(1,771),depthTest:null,depthWrite:null,colorWrite:_})})}disposeResources(){o(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}createTextureResources(e,s){if(o(this._imageSources))return null;this._imageSources.overlay.width=s,this._imageSources.overlay.height=s,this._imageSources.mask.width=s,this._imageSources.mask.height=s;const r=new k(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0,preMultiplyAlpha:!p(this._imageSources.overlay.src)||!T(e).svgAlwaysPremultipliesAlpha},this._imageSources.overlay),t=new k(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new k(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:t,overlay:r,size:s}}createProgram(e){const s=j();return new y(e,s,this.attributeLocations)}};e([c()],w.prototype,"_imageSources",void 0),e([c()],w.prototype,"_imageLoadTask",void 0),e([c({readOnly:!0})],w.prototype,"updating",null),w=e([h("esri/views/3d/webgl-engine/lib/MagnifierHelper")],w);export{w as MagnifierHelper};
