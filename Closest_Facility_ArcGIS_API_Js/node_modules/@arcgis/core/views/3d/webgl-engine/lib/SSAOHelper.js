/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{disposeMaybe as e,isSome as t,isNone as s}from"../../../../core/maybe.js";import{a as i}from"../../../../chunks/vec2f64.js";import{i as r}from"../../../../chunks/vec3.js";import{c as h}from"../../../../chunks/vec4f64.js";import{requestImage as o}from"../../../../support/requestImageUtils.js";import{createQuadVAO as a}from"./glUtil3D.js";import{SSAOTechniqueConfiguration as n,SSAOTechnique as u}from"./SSAOTechnique.js";import{inverseProjectionInfo as l}from"./Util.js";import _ from"../../../webgl/FramebufferObject.js";import b from"../../../webgl/Texture.js";import{vertexCount as m}from"../../../webgl/Util.js";class d{constructor(e,t,s){this._techniqueRep=e,this._rctx=t,this._requestRender=s,this._enabled=!1,this._ssaoTechniqueConfig=new n,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}dispose(){this.quadVAO=e(this.quadVAO)}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&t(this._noiseTexture)&&t(this._ssaoFBO)&&t(this._blur0FBO)&&t(this._blur1FBO)}computeSSAO(e,t,i){if(!this.enabled||s(this._noiseTexture)||s(this._ssaoFBO)||s(this._blur0FBO)||s(this._blur1FBO))return;const h=this._rctx,o=e.fullViewport,n=o[2],u=o[3],_=n/this._blurSizePx,b=u/this._blurSizePx;this._ssaoFBO.resize(n,u),this._blur0FBO.resize(_,b),this._blur1FBO.resize(_,b);const d=1,p=1,O=n*d,x=u*p;h.bindFramebuffer(this._ssaoFBO),h.setViewport(0,0,n,u);const F=this._ssaoTechnique.program;h.useProgram(F),h.setPipelineState(this._ssaoTechnique.pipeline),F.setUniform2f("rnmScale",n/this._noiseTexture.descriptor.width,u/this._noiseTexture.descriptor.height),l(e.projectionMatrix,e.fullWidth,e.fullHeight,f,c),F.setUniform4fv("projInfo",f),F.setUniform2fv("zScale",c),F.setUniform2f("nearFar",e.near,e.far);let g=1/e.computeRenderPixelSizeAtDist(1);F.setUniform1f("projScale",g*d),F.setUniform2f("screenDimensions",O,x);const T=r(e.eye,e.center);let B=20*e.computeRenderPixelSizeAtDist(T);B=Math.max(.1,B),F.setUniform1f("radius",B),F.setUniform1f("intensity",4*this._attenuation/B**6),F.bindTexture(this._noiseTexture,"rnm"),F.bindTexture(i,"normalMap"),F.bindTexture(t,"depthMap"),s(this.quadVAO)&&(this.quadVAO=a(this._rctx)),h.bindVAO(this.quadVAO),h.drawArrays(5,0,m(this.quadVAO,"geometry"));const q=this._blurTechnique.program;h.useProgram(q),q.bindTexture(this._ssaoFBO.colorTexture,"tex"),q.bindTexture(i,"normalMap"),q.bindTexture(t,"depthMap"),h.setViewport(0,0,O/this._blurSizePx,x/this._blurSizePx),h.bindFramebuffer(this._blur0FBO),q.setUniform2f("screenDimensions",O,x),q.setUniform2f("blurSize",0,this._blurSizePx*d/x),q.setUniform2f("nearFar",e.near,e.far),T>5e4&&(g=Math.max(0,g-(T-5e4))),q.setUniform1f("projScale",g),h.drawArrays(5,0,m(this.quadVAO,"geometry")),q.setUniform2f("blurSize",this._blurSizePx*p/O,0),h.bindFramebuffer(this._blur1FBO),q.bindTexture(this._blur0FBO.colorTexture,"tex"),h.drawArrays(5,0,m(this.quadVAO,"geometry")),h.setViewport(o[0],o[1],o[2],o[3])}bind(e,s){this.enabled&&t(this._blur1FBO)&&t(this._ssaoFBO)?(e.bindTexture(this._blur1FBO.colorTexture,"ssaoTex"),e.setUniform4f("viewportPixelSz",s.fullViewport[0],s.fullViewport[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height)):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}_selectPrograms(){this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(u,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.releaseAndAcquire(u,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))}_loadResources(e){this._data?e():import("./SSAOHelperData.js").then((t=>{this._data=t,e()}))}_initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};o(this._data.noiseTexture).then((s=>{this._enabled&&(this._ssaoFBO=new _(this._rctx,t,e),this._blur0FBO=new _(this._rctx,t,e),this._blur1FBO=new _(this._rctx,t,e),this._noiseTexture=new b(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:s.width,height:s.height},s),this._requestRender())})),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=e(this._noiseTexture),this._blur1FBO=e(this._blur1FBO),this._blur0FBO=e(this._blur0FBO),this._ssaoFBO=e(this._ssaoFBO)}get gpuMemoryUsage(){return(t(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(t(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(t(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const c=i(),f=h();export{d as SSAOHelper};
