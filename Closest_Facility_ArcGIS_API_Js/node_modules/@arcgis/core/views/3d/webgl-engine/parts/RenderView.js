/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import r from"../../../../core/Evented.js";import i from"../../../../core/has.js";import s from"../../../../core/Logger.js";import{isNone as o,isSome as n}from"../../../../core/maybe.js";import{addFrameTask as a}from"../../../../core/scheduling.js";import{Milliseconds as d}from"../../../../core/time.js";import{init as p}from"../../../../core/watchUtils.js";import{property as h}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../core/accessorSupport/decorators/subclass.js";import{DESIRED_ANIMATION_MS as l}from"../../support/animationUtils.js";import{ComponentObjectCollection as m}from"../collections/Component/ComponentObjectCollection.js";import{ShaderTechniqueRepository as u}from"../core/shaderTechnique/ShaderTechniqueRepository.js";import{autoDispose as _,AutoDisposableMixin as g}from"../lib/AutoDisposable.js";import f from"../lib/CompositingHelper.js";import{textureToDepth as y}from"../lib/depthRangeUtils.js";import R from"../lib/GLMaterialRep.js";import{MagnifierHelper as x}from"../lib/MagnifierHelper.js";import b from"../lib/Renderer.js";import{TextureRepository as v}from"../lib/TextureRepository.js";import{clearTestWebGLDriver as w,testWebGLDriver as j}from"../lib/WebGLDriverTest.js";import{StippleTextureRepository as T}from"../materials/StippleTextureRepository.js";import{WaterTextureRepository as U}from"../materials/internal/WaterTextureRepository.js";import{removeLoadedShaderModules as S}from"./requireUtils.js";import{ScreenshotManager as C}from"./ScreenshotManager.js";import{createContextOrErrorHTML as M,createContext as L}from"../../../webgl/context-util.js";import A from"../../../webgl/RenderingContext.js";const O=s.getLogger("esri.views.3d.webgl-engine.parts.View");let H=class extends(g(t)){constructor(e){super({}),this.events=new r,this.waterTextureRepository=new U,this._magnifierHelper=new x,this._componentObjectCollection=null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._logicUpdateLast=0,this._container=e.container,this._initializeContext(e.options),p(this.waterTextureRepository,"loadingState",(()=>this.setNeedsRender())),this._magnifierHelper.events.on("request-render",(()=>this.setNeedsRender())),this._stippleTextureRepository=new T(this._rctx),this._shaderTechniqueRepository=new u({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new v(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.setNeedsRender(e))),this._materialRepository=new R(this._textureRepository,this._shaderTechniqueRepository,(()=>this.setNeedsRender())),this._compositingHelper=new f(this._rctx,this._shaderTechniqueRepository),this._renderer=new b(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,((e=1)=>this.setNeedsRender(e)),((t,r)=>e.schedule(t,r)),e),this._screenshotManager=new C(this._rctx,((e,t,r)=>this._renderer.render(e,t,t,r)),(()=>this.setNeedsRender()),e.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,w(this._rctx),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}setNeedsRender(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0}get needsUpdate(){return this._needsUpdate}get updating(){return this.evaluateUpdating()}evaluateUpdating(){return this.needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}updateLightSources(e,t,r){this._renderer.updateLightSources(e,t,r),this.setNeedsRender()}setRenderParameters(e){void 0!==e.idleSuspend&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.setNeedsRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(e){this._renderer.modify(e),e.clear()}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}get hasShadowsEnabled(){return this._renderer.hasShadowsEnabled}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}getMinimalDepthForArea(e,t,r,i,s=i){const o=r.constrainWindowSize(e,t,i*r.pixelRatio,s*r.pixelRatio),n=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(r,o[0],o[1],o[2],o[3],n);let a=Number.MAX_VALUE;for(let d=0;d<o[2]*o[3];d++){const e=y(4*d,n,r.nearFar);a>e&&e!==r.nearFar[0]&&e!==r.nearFar[1]&&(a=e)}return a===Number.MAX_VALUE?void 0:a}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(o(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}getGpuMemoryUsage(){return this._renderer.getGpuMemoryUsage()}async hotReloadShaders(){S(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()}_registerFrameTask(e){const t=e.state,r={viewCamera:t.camera,frameHasDecorations:!1};let i=!1;const s={preRender:r=>{i=this.evaluateUpdating(),e.processSyncLayers();const s=d(r.time-this._logicUpdateLast);if(s>l||n(this.forcedAnimationTime)){const e={camera:t.camera,dt:s,forcedTime:this.forcedAnimationTime};this._logicUpdateLast=r.time,this._renderer.updateLogic(e)&&this.setNeedsRender(0)}},render:()=>{if((this.needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const e=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,!1),e&&this._renderer.hasWaterReflection&&(this.setNeedsRender(0),this._needsWaterReflectionUpdate=!0)}},postRender:()=>{i===this.updating&&i===this.evaluateUpdating()||this.notifyChange("updating")},update:()=>{r.viewCamera=t.camera,r.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(r)}};this._frameTask=a(s)}_initializeContext(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"};let r;const s=i("esri-force-webgl");if(s?r=M(this._canvas,s,t):(r=L(this._canvas,2,t),o(r)&&(r=M(this._canvas,1,t))),o(r))return void O.error(s);const n={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{},maxAnisotropy:8};this._rctx=new A(r,n),j(this._rctx),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&O.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&i("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return o(this._componentObjectCollection)&&(this._componentObjectCollection=new m(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};e([h({type:Boolean,readOnly:!0})],H.prototype,"updating",null),e([_()],H.prototype,"_rctx",void 0),e([_()],H.prototype,"_container",void 0),e([_()],H.prototype,"_canvas",void 0),e([_()],H.prototype,"_stippleTextureRepository",void 0),e([_(),h()],H.prototype,"waterTextureRepository",void 0),e([_(),h()],H.prototype,"_magnifierHelper",void 0),e([_(),h()],H.prototype,"_textureRepository",void 0),e([_()],H.prototype,"_compositingHelper",void 0),e([_()],H.prototype,"_renderer",void 0),e([_()],H.prototype,"_screenshotManager",void 0),e([_()],H.prototype,"componentObjectCollection",null),e([_()],H.prototype,"_componentObjectCollection",void 0),H=e([c("esri.views.3d.webgl-engine.parts.RenderView")],H);export{H as RenderView};
