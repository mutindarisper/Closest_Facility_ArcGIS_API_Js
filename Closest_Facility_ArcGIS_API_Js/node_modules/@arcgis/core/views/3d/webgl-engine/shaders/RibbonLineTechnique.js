/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{isSome as t,unwrap as i,unwrapOr as r}from"../../../../core/maybe.js";import{bindSliceUniformsWithOrigin as o}from"../core/shaderLibrary/Slice.glsl.js";import{bindOutputHighlight as s}from"../core/shaderLibrary/output/OutputHighlight.glsl.js";import{bindMultipassTerrainTexture as n}from"../core/shaderLibrary/shading/MultipassTerrainTest.glsl.js";import{bindVisualVariablesUniformsWithOpacity as p}from"../core/shaderLibrary/shading/VisualVariables.glsl.js";import{bindProjectionMatrix as l,bindView as a}from"../core/shaderLibrary/util/View.glsl.js";import{ReloadableShaderModule as d}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as c}from"../core/shaderTechnique/ShaderTechnique.js";import{parameter as u,ShaderTechniqueConfiguration as h}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{blendingDefault as f,OITBlending as m,OITDepthTest as g,OITDepthWrite as b,OITPolygonOffset as v}from"../lib/OrderIndependentTransparency.js";import{Program as y}from"../lib/Program.js";import{stencilWriteMaskOn as T,stencilToolMaskBaseParams as E,stencilBaseAllZerosParams as P,depthCompareAlways as O,stencilToolTransparentOccluderParams as x,stencilWriteMaskOff as C,stencilToolMaskOccluderParams as S,depthCompareLess as R}from"../lib/StencilUtils.js";import{R as j}from"../../../../chunks/RibbonLine.glsl.js";import{makePipelineState as W,defaultDepthWriteParams as U,defaultColorWriteParams as w}from"../../../webgl/renderState.js";const z=new Map([["position",0],["subdivisionFactor",1],["uv0",2],["auxpos1",3],["auxpos2",4],["size",6],["sizeFeatureAttribute",6],["color",5],["colorFeatureAttribute",5],["opacityFeatureAttribute",7]]);class I extends c{constructor(e,t,i){super(e,t,i),this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=I.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:i.draped,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:i.stippleIntegerRepeatsEnabled,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled,roundCaps:i.roundCaps,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new y(e.rctx,r,z)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,o){if(l(this.program,o.camera.projectionMatrix),4===this.configuration.output&&s(this.program,o),o.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",o.inverseViewport),n(this.program,o)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit","miter"!==e.join?0:e.miterLimit),this.program.setUniform2fv("cameraNearFar",o.camera.nearFar),this.program.setUniform1f("pixelRatio",o.camera.pixelRatio),this.program.setUniform2f("screenSize",o.camera.fullViewport[2],o.camera.fullViewport[3]),p(this.program,e),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.configuration.stippleEnabled){const{pixelSize:r,sdfNormalizer:s}=t(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.configuration.draped?(this.program.setUniform1f("stipplePatternPixelSizeInv",1/r),this.program.setUniform1f("worldToScreenRatio",1/o.screenToWorldRatio)):this.program.setUniform1f("stipplePatternPixelSizeInv",1/(r*o.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=i(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",r(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*o.camera.pixelRatio))}bindDraw(e){a(this.program,e),o(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,t){const i=this.configuration,r=3===e,o=2===e;return W({blending:0===i.output||7===i.output?r?f:m(e):null,depthTest:{func:g(e)},depthWrite:r?!i.transparent&&i.writeDepth&&U:b(e),colorWrite:w,stencilWrite:i.sceneHasOcludees?T:null,stencilTest:i.sceneHasOcludees?t?E:P:null,polygonOffset:r||o?i.polygonOffset&&L:v})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&L;return e.occluder&&(this._occluderPipelineTransparent=W({blending:f,polygonOffset:t,depthTest:O,depthWrite:null,colorWrite:w,stencilWrite:null,stencilTest:x}),this._occluderPipelineOpaque=W({blending:f,polygonOffset:t,depthTest:O,depthWrite:null,colorWrite:w,stencilWrite:C,stencilTest:S}),this._occluderPipelineMaskWrite=W({blending:null,polygonOffset:t,depthTest:R,depthWrite:null,colorWrite:null,stencilWrite:T,stencilTest:E})),this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return 5}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?11===e?this._occluderPipelineTransparent:10===e?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:this.pipeline}}I.shader=new d(j,(()=>import("./RibbonLine.glsl.js")));const L={factor:0,units:-4};class V extends h{constructor(){super(...arguments),this.output=0,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.roundCaps=!1,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}e([u({count:8})],V.prototype,"output",void 0),e([u()],V.prototype,"occluder",void 0),e([u()],V.prototype,"slicePlaneEnabled",void 0),e([u()],V.prototype,"transparent",void 0),e([u()],V.prototype,"polygonOffset",void 0),e([u()],V.prototype,"writeDepth",void 0),e([u()],V.prototype,"draped",void 0),e([u()],V.prototype,"stippleEnabled",void 0),e([u()],V.prototype,"stippleOffColorEnabled",void 0),e([u()],V.prototype,"stippleIntegerRepeatsEnabled",void 0),e([u()],V.prototype,"roundCaps",void 0),e([u()],V.prototype,"roundJoins",void 0),e([u()],V.prototype,"vvSize",void 0),e([u()],V.prototype,"vvColor",void 0),e([u()],V.prototype,"vvOpacity",void 0),e([u()],V.prototype,"falloffEnabled",void 0),e([u()],V.prototype,"innerColorEnabled",void 0),e([u()],V.prototype,"sceneHasOcludees",void 0),e([u({count:4})],V.prototype,"transparencyPassType",void 0),e([u()],V.prototype,"multipassTerrainEnabled",void 0),e([u()],V.prototype,"cullAboveGround",void 0);export{I as RibbonLineTechnique,V as RibbonLineTechniqueConfiguration,z as ribbonVertexAttributeLocations};
