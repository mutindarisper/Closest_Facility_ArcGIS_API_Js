/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as o}from"../chunks/tslib.es6.js";import t from"../core/Accessor.js";import e from"../core/Collection.js";import{HandleOwner as i}from"../core/HandleOwner.js";import a from"../core/Logger.js";import{isSome as s,isNone as r}from"../core/maybe.js";import{watch as l}from"../core/watchUtils.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import"../core/has.js";import"../core/accessorSupport/ensureType.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import{ViewEventPriorities as c}from"./input/InputManager.js";import{eventTypes as p}from"./input/ViewEvents.js";import{getToolAttachDetachHandles as u,areToolManipulatorsEditable as d}from"./interactive/interactiveToolUtils.js";import v from"./interactive/ToolViewManagerManipulatorState.js";const m=a.getLogger("esri.views.ToolViewManager"),f="manipulators",T="tools";let _=class extends i{constructor(o){super(o),this._manipulatorState=new v,this.tools=new e,this.cursor=null,this._forEachTool=o=>{for(const t of this.tools.items)if(o(t))return}}initialize(){this.handles.add([this.view.on(p,(o=>{this._handleInputEvent(o)}),c.TOOL),...u(this.tools),this.tools.on("before-add",(o=>{const t=o.item;if(null==t||this.tools.includes(t))return m.warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void o.preventDefault()})),this.tools.on("before-remove",(({item:o})=>{this._manipulatorState.clearPointers(o,this._forEachTool)})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this._forEachTool((o=>o.destroy()))}set activeTool(o){if(s(o)&&!this.view.ready)return void m.error("Cannot set active tool while view is not ready.");if(o===this.activeTool)return void m.warn("Tool is already active - ignoring activation request.");s(this.activeTool)&&this.activeTool.deactivate(),s(o)&&o.activate(),this._set("activeTool",o),this._removeIncompleteTools(o);const t=r(this.activeTool);for(const e of this.tools){e.setEditableFlag(1,t||e===this.activeTool);const o=d(e);!t&&o||this._manipulatorState.clearPointers(e,this._forEachTool,!o)}this._updateCursor()}get updating(){return this.updatingHandles.updating||this.tools.some((o=>o.updating))}attach(){this._forEachTool((o=>o.attach())),"3d"===this.view.type?this.handles.add([this.view.state.watch("camera",(()=>{this._forEachManipulator((o=>{null!=o.onViewChange&&o.onViewChange()}))})),this.view.elevationProvider.on("elevation-change",(o=>{this._forEachManipulator((t=>{null!=t.onElevationChange&&t.onElevationChange(o)}))}))],f):this.handles.add(this.view.watch("extent",(()=>{this._forEachManipulator((o=>{null!=o.onViewChange&&o.onViewChange()}))})))}detach(){s(this.activeTool)&&(this.activeTool=null),this._forEachTool((o=>{o.detach(),o.destroy()})),this.tools.removeAll(),this.handles.remove(f)}_forEachManipulator(o){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:e})=>o(e,t)))}))}_handleInputEvent(o){let t=!1;const e={...o,stopPropagation:()=>{t=!0,o.stopPropagation()}};s(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(e):this._forEachTool((o=>{!t&&o.attached&&o.visible&&o.handleInputEvent(e)})),!t&&"key-down"===o.type&&"Escape"===o.key&&this.activeTool&&(o.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(e,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:o=>{this.activeTool=o},view:this.view}),!t&&s(this.activeTool)&&this.activeTool.handleInputEventAfter(e),this._manipulatorState.handleHoverEvent(e,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(T),this._forEachTool((o=>{if(o instanceof t){const t=l(o,["cursor","visible","editable"],(()=>{d(o)||this._manipulatorState.clearPointers(o,this._forEachTool),this._updateCursor()}));this.handles.add(t,T)}o.manipulators&&this.handles.add(o.manipulators.on("change",(t=>{t.removed.forEach((({id:t})=>{this._manipulatorState.clearPointers(o,this._forEachTool,!0,t)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})),T)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){let o=this._manipulatorState.cursor;this._forEachTool((t=>!(!s(t.cursor)||!t.visible)&&(o=t.cursor,!0))),this._get("cursor")!==o&&this._set("cursor",o)}_removeIncompleteTools(o){this.tools.filter((t=>(r(o)||t!==o)&&!t.completed)).forEach((o=>{this.tools.remove(o),o.destroy()}))}};o([n({constructOnly:!0,nonNullable:!0})],_.prototype,"view",void 0),o([n({value:null})],_.prototype,"activeTool",null),o([n({readOnly:!0,type:e})],_.prototype,"tools",void 0),o([n({readOnly:!0})],_.prototype,"cursor",void 0),o([n({readOnly:!0})],_.prototype,"updating",null),_=o([h("esri.views.ToolViewManager")],_);var E=_;export{E as default};
