/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import{HandleOwnerMixin as t}from"../../../../core/HandleOwner.js";import{destroyHandle as i}from"../../../../core/handleUtils.js";import{isSome as s}from"../../../../core/maybe.js";import{init as o}from"../../../../core/watchUtils.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/Logger.js";import{subclass as n}from"../../../../core/accessorSupport/decorators/subclass.js";import{reaction as l}from"../../../../core/accessorSupport/trackingUtils.js";import{FeatureServiceTiles2D as u}from"../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D.js";import{FeatureServiceTiles3D as c}from"../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D.js";import{convertSnappingCandidate as p}from"./queryEngineUtils.js";import{WorkerTileTreeDebugger as d}from"./WorkerTileTreeDebugger.js";import{FeatureServiceSnappingSourceWorkerHandle as h}from"./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle.js";import{FeatureServiceTilesSimple as f}from"./featureServiceSource/FeatureServiceTilesSimple.js";import m from"../../../support/debugFlags.js";let y=class extends(t(r)){constructor(e){super(e)}get updateTilesParameters(){return{tiles:this.tilesOfInterest.tiles,tileInfo:this.tilesOfInterest.tileInfo,tileSize:this.tilesOfInterest.tileSize}}get updating(){return this.workerHandle.updating||this.updatingHandles.updating}get configuration(){return{filter:this.layer.createQuery(),customParameters:this.layer.customParameters}}get availability(){return this.workerHandle.availability}get layer(){return this.layerSource.layer}initialize(){const e=this.view;if(s(e))switch(e.type){case"2d":this.tilesOfInterest=new u({view:e,layer:this.layer}),this.workerHandle=new h;break;case"3d":{const r=e.resourceController;this.tilesOfInterest=new c({view:e}),this.workerHandle=new h({schedule:e=>r.schedule(e)});break}}else this.tilesOfInterest=new f({layer:this.layer}),this.workerHandle=new h;this.handles.add([i(this.workerHandle)]),this.workerHandle.setup({layer:this.layer,spatialReference:this.spatialReference,configuration:this.configuration},null),this.updatingHandles.add(this,"updateTilesParameters",(()=>this.workerHandle.updateTiles(this.updateTilesParameters,null)),2),this.handles.add([l((()=>this.configuration),(e=>this.workerHandle.configure(e,null)))]),s(e)&&this.handles.add(o(m,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",(r=>{r&&!this.debug?(this.debug=new d({view:e,handle:this.workerHandle}),this.handles.add(i(this.debug),"debug")):!r&&this.debug&&this.handles.remove("debug")}))),this.handles.add(this.layerSource.layer.on("apply-edits",(e=>{this.workerHandle.applyEdits(e,null)})))}refresh(){this.workerHandle.refresh(null)}async fetchCandidates(e,r){return this.tilesOfInterest.pointOfInterest=e.coordinateHelper.vectorToPoint(e.point),(await this.workerHandle.fetchCandidates({...e,filter:null},r)).candidates.map((r=>p(r,e.coordinateHelper)))}getDebugInfo(e){return this.workerHandle.getDebugInfo(e)}};e([a({constructOnly:!0})],y.prototype,"spatialReference",void 0),e([a({constructOnly:!0})],y.prototype,"layerSource",void 0),e([a({constructOnly:!0})],y.prototype,"view",void 0),e([a()],y.prototype,"tilesOfInterest",void 0),e([a({readOnly:!0})],y.prototype,"updateTilesParameters",null),e([a({readOnly:!0})],y.prototype,"updating",null),e([a({readOnly:!0})],y.prototype,"configuration",null),e([a({readOnly:!0})],y.prototype,"availability",null),y=e([n("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],y);export{y as FeatureServiceSnappingSource};
