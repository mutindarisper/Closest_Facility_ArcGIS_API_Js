/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import"../../core/has.js";import{clamp as t}from"../../core/mathUtils.js";const h=2048,i=1.5,e=8;function o(h,i){const{format:e,quality:o,rotation:n,disableDecorations:a}=h||{},r=x(h,i.padding),l=M(h,{width:i.width-r.left-r.right,height:i.height-r.top-r.bottom}),{width:g,height:d}=m(h,l),f=b(e),u=P[f];return{format:f,quality:t(null!=o?o:u,0,100),area:l,width:g,height:d,rotation:n,disableDecorations:!!a,ignoreBackground:!(!h||!h.ignoreBackground),ignorePadding:!(!h||!h.ignorePadding)}}function n(t,h){const i=o(t,h),e=i.area,n=i.width/e.width,a=x(i,h.padding),r=a.left+a.right,l=a.top+a.bottom,g=h.width-r,d=h.height-l,f=Math.floor(g*n+r),u=Math.floor(d*n+l),c=t&&t.layers?t.layers:[],s=i.ignoreBackground,w=i.ignorePadding;return{framebufferWidth:f,framebufferHeight:u,region:{x:Math.floor(e.x*n)+a.left,y:Math.floor(e.y*n)+a.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:n,layers:c,disableDecorations:i.disableDecorations,ignoreBackground:s,ignorePadding:w}}function a(t,h,i,e){e.premultipliedAlpha&&D(t),i.width=t.width,i.height=t.height;const o=i.getContext("2d");o.putImageData(t,0,0),e.flipY&&j(o);const n=o.getImageData(0,0,t.width,t.height),a=r(i,h);return i.width=0,i.height=0,{dataUrl:a,data:n}}function r(t,h){const i=q[h.format],e=h.quality/100;return t.toDataURL(i,e)}function l(t,h,i){if(!t||!h)throw new Error("Cannot construct image data without dimensions");if(s)try{return new ImageData(t,h)}catch(e){s=!1}return u(t,h,i)}function g(t,h,i,e){if(!h||!i)throw new Error("Cannot construct image data without dimensions");if(s)try{return new ImageData(t,h,i)}catch(n){s=!1}const o=u(h,i,e);return o.data.set(t,0),o}function d(t,h,i,e=0,o=0,n=t.width-e,a=t.height-o,r=!1){const{data:l}=t,{width:g,height:d,data:f}=h,u=n/g,c=a/d,s=Math.ceil(u/2),w=Math.ceil(c/2),m=t.width;for(let M=0;M<d;M++)for(let t=0;t<g;t++){const h=4*(t+(r?d-M-1:M)*g);let n=0,a=0,p=0,y=0,x=0,b=0;const j=(M+.5)*c;for(let r=Math.floor(M*c);r<(M+1)*c;r++){const h=Math.abs(j-(r+.5))/w,g=(t+.5)*u,d=h*h;for(let f=Math.floor(t*u);f<(t+1)*u;f++){const t=Math.abs(g-(f+.5))/s,h=Math.sqrt(d+t*t);if(h>=1)continue;let u=2*h*h*h-3*h*h+1;const c=4*(e+f+(o+r)*m);b+=u*l[c+3],a+=u,!i&&l[c+3]<255&&(u=u*l[c+3]/255),p+=u*l[c],y+=u*l[c+1],x+=u*l[c+2],n+=u}}f[h]=p/n,f[h+1]=y/n,f[h+2]=x/n,f[h+3]=b/a}return h}function f(t,o,n){if(!o)return t;const{framebufferWidth:a,framebufferHeight:r,pixelRatio:l,region:g}=t,d=x(t,n),f=d.left+d.right,u=d.top+d.bottom,c=a-f,s=r-u,w=Math.min(e,Math.min((h-f)/c,(h-u)/s));return w<i?t:{...t,framebufferWidth:Math.round(c*w)+f,framebufferHeight:Math.round(s*w)+u,pixelRatio:l*w,resample:{region:{x:Math.round((g.x-d.left)*w)+d.left,y:Math.round((g.y-d.top)*w)+d.top,width:Math.round(g.width*w),height:Math.round(g.height*w)},width:a,height:r}}}function u(t,h,i){return i||(i=w()),i.getContext("2d").createImageData(t,h)}let c=null,s=!0;function w(){return c||(c=document.createElement("canvas"),c.width=1,c.height=1),c}function m(t,h){if(!t)return h;const i=t.width,e=t.height;if(null!=i&&null!=e)return{width:Math.floor(i),height:Math.floor(e)};if(null==i&&null==e)return h;const o=h.width/h.height;return null==e?{width:Math.floor(i),height:Math.floor(i/o)}:{width:Math.floor(e*o),height:Math.floor(e)}}function M(t,h){const i={x:0,y:0,width:h.width,height:h.height};if(t&&t.area){null!=t.area.x&&(i.x=Math.floor(t.area.x)),null!=t.area.y&&(i.y=Math.floor(t.area.y));const e=null!=t.area.width?Math.floor(t.area.width):null,o=null!=t.area.height?Math.floor(t.area.height):null;if(i.width=h.width-i.x,i.height=h.height-i.y,null!=e&&null!=o)i.width=Math.min(i.width,e),i.height=Math.min(i.height,o);else if(null==e&&null!=o){const t=Math.min(i.width,e);i.height=t/i.width*i.height,i.width=t}else if(null!=e&&null==o){const t=Math.min(i.height,o);i.width=t/i.height*i.width,i.height=t}}return p(y(i,t),h)}function p(t,h){const i=Math.floor(Math.max(t.x,0)),e=Math.floor(Math.max(t.y,0)),o={x:i,y:e,width:Math.floor(Math.min(t.width,h.width-i)),height:Math.floor(Math.min(t.height,h.height-e))},n=o.width/o.height,a=t.width/t.height;if(a===n)return o;if(a>n){const t=Math.floor(o.width/a),h=o.height-t;return{x:o.x,y:Math.floor(o.y+h/2),width:o.width,height:t}}const r=Math.floor(o.height*a),l=o.width-r;return{x:Math.floor(o.x+l/2),y:o.y,width:r,height:o.height}}function y(t,h){if(!h||null==h.width||null==h.height)return t;const i=h.width/h.height,e=t.width/t.height;if(e===i)return t;if(e<i){const h=Math.floor(t.height*i);return t.x-=(h-t.width)/2,t.width=h,t}const o=Math.floor(t.width/i);return t.y-=(o-t.height)/2,t.height=o,t}function x(t,h){return!h||t&&t.ignorePadding?k:h}function b(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return C}}function j(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}function D(t){const h=t.data,i=h.length;for(let e=0;e<i;e+=4){const t=h[e+3];if(t>0){const i=t/255;h[e+0]=h[e+0]/i,h[e+1]=h[e+1]/i,h[e+2]=h[e+2]/i}}}const q={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},I=98,C="png",P={png:100,jpg:I,jpeg:I},k={top:0,right:0,bottom:0,left:0};export{o as completeUserSettings,l as createEmptyImageData,a as encodeResult,d as resampleHermite,f as screenshotSuperSampleSettings,r as toDataUrl,n as toRenderSettings,g as wrapImageData};
