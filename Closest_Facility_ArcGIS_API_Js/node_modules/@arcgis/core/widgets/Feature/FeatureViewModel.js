/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import{FeatureSetQueryInterceptor as r}from"../../arcade/featureset/support/FeatureSetQueryInterceptor.js";import i from"../../core/Accessor.js";import o from"../../core/Handles.js";import s from"../../core/Logger.js";import{isSome as a}from"../../core/maybe.js";import{createAbortController as n,isAbortError as l,eachAlways as p}from"../../core/promiseUtils.js";import{throttle as c}from"../../core/throttle.js";import{init as d}from"../../core/watchUtils.js";import{property as u}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import{cast as f}from"../../core/accessorSupport/decorators/cast.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import m from"../../popup/content/TextContent.js";import _ from"./FeatureAttachments/FeatureAttachmentsViewModel.js";import y from"./FeatureContent/FeatureContentViewModel.js";import g from"./FeatureFields/FeatureFieldsViewModel.js";import b from"./FeatureMedia/FeatureMediaViewModel.js";import{createCompiledExpressions as v}from"./support/arcadeFeatureUtils.js";import{preLayerQueryCallback as I,preRequestCallback as A,createfieldInfoMap as w,getAllFieldInfos as M,getSourceLayer as C,substituteFieldsInLinksAndAttributes as T,formatEditInfo as x,graphicCallback as F,queryUpdatedFeature as j,formatAttributes as V,isRelatedField as P}from"./support/featureUtils.js";import{queryLayerInfos as L,queryRelatedFeatures as E,setRelatedFeatures as R,getRelatedFieldInfo as O,createRelatedInfo as S,updateRelatedInfo as k}from"./support/relatedFeatureUtils.js";var U;const q=1,D="esri.widgets.FeatureViewModel",N=s.getLogger(D),Q={attachmentsContent:!0,customContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};let B=U=class extends i{constructor(e){super(e),this._handles=new o,this._error=null,this._featureAbortController=null,this.graphicChangedThrottled=c(this.graphicChanged,q,this),this._expressionAttributes=null,this.abilities={...Q},this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=e=>{const{abilities:t}=this;return"attachments"===e.type&&t.attachmentsContent||"custom"===e.type&&t.customContent||"fields"===e.type&&t.fieldsContent||"media"===e.type&&t.mediaContent||"text"===e.type&&t.textContent},this._handles.add(d(this,["graphic","_effectivePopupTemplate","abilities"],(()=>this.graphicChangedThrottled())))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return a(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return w(M(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return C(this.graphic)}castAbilities(e){return{...Q,...e}}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?e.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(e){void 0!==e?this._override("map",e):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const r=this.contentViewModels[e];r instanceof b&&r.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof b&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof b&&t.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:e}=this;if(!e)return;const t=n();this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(r){l(r)||(this._error=r,N.error("error","The popupTemplate could not be displayed for this feature.",{error:r,graphic:e,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map(((e,t)=>"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):void 0)):"string"==typeof e?this._compileText(new m({text:e}),0).text:e}_destroyContentViewModels(){this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])}_compileAttachments(e,t){const{graphic:r}=this,{description:i,title:o}=e;return this.contentViewModels[t]=new _({graphic:r,...this._compileTitleAndDesc({title:o,description:i})}),e}_compileCustom(e,t){const{graphic:r}=this,{creator:i,destroyer:o}=e;return this.contentViewModels[t]=new y({graphic:r,creator:i,destroyer:o}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:r,_sourceLayer:i,graphic:o,formattedAttributes:s,_expressionAttributes:a}=this,{attributes:n}=o,l=s.global;return{title:T({attributes:n,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:i,text:e}),description:T({attributes:n,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:i,text:t})}}_compileFields(e,t){const{_effectivePopupTemplate:r,formattedAttributes:i}=this,o=e.clone(),s=(null==e?void 0:e.fieldInfos)||(null==r?void 0:r.fieldInfos),a=null==r?void 0:r.expressionInfos,n={...i.global,...i.content[t]},{description:l,title:p}=o,c=new g({attributes:n,expressionInfos:a,fieldInfos:s,...this._compileTitleAndDesc({title:p,description:l})});return this.contentViewModels[t]=c,o.fieldInfos=c.formattedFieldInfos.slice(0),o}_compileMedia(e,t){const{graphic:r,_fieldInfoMap:i,_effectivePopupTemplate:o,relatedInfos:s,_sourceLayer:a,_expressionAttributes:n}=this,{attributes:l}=r,p=this.formattedAttributes.global,c=e.clone(),{description:d,mediaInfos:u,title:f}=c,h=new b({activeMediaInfoIndex:c.activeMediaInfoIndex||0,attributes:l,layer:a,fieldInfoMap:i,formattedAttributes:p,expressionAttributes:n,mediaInfos:u,popupTemplate:o,relatedInfos:s,...this._compileTitleAndDesc({title:f,description:d})});return c.mediaInfos=h.formattedMediaInfos.slice(0),this.contentViewModels[t]=h,c}_compileText(e,t){const r=e.clone(),{graphic:i,_fieldInfoMap:o,_sourceLayer:s,_expressionAttributes:a}=this;if(r&&r.text){const{attributes:e}=i,t=this.formattedAttributes.global;r.text=T({attributes:e,fieldInfoMap:o,globalAttributes:t,expressionAttributes:a,layer:s,text:r.text})}return this.contentViewModels[t]=new y({graphic:i,creator:r.text}),r}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:r}=this;if(!e)return;const{lastEditInfoEnabled:i}=e,o=null==t?void 0:t.editFieldsInfo;return i&&o?x(o,r.attributes):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:r,graphic:i,_expressionAttributes:o}=this,{attributes:s}=i,a=this.formattedAttributes.global;return T({attributes:s,fieldInfoMap:t,globalAttributes:a,expressionAttributes:o,layer:r,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.title;return F(r,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this,r=null==e?void 0:e.content;return F(r,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:r,graphic:i,_effectivePopupTemplate:o,spatialReference:s,map:a,view:n}=this,{content:{value:l},title:{value:c}}=await p({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!i)return;await j({graphic:i,popupTemplate:o,layer:r,spatialReference:s},e);const{expressionAttributes:{value:d}}=await p({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:v({popupTemplate:this._effectivePopupTemplate,spatialReference:s,graphic:i,map:a,interceptor:U.interceptor,view:n})});t===this._featureAbortController&&i&&(this._expressionAttributes=d,this._set("formattedAttributes",this._createFormattedAttributes(l,d)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createFormattedAttributes(e,t){const{_effectivePopupTemplate:r,graphic:i,relatedInfos:o,_sourceLayer:s,_fieldInfoMap:a}=this,n=null==r?void 0:r.fieldInfos,l={...i.attributes,...t},p={global:V({fieldInfos:n,graphic:i,attributes:l,layer:s,fieldInfoMap:a,relatedInfos:o}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(p.content[t]=V({fieldInfos:e.fieldInfos,graphic:i,attributes:l,layer:s,fieldInfoMap:a,relatedInfos:o}))})),p}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(t,M(r),e)}async _queryRelatedInfos(e,t,r){const{relatedInfos:i,_sourceLayer:o}=this;i.clear();const s=a(o.associatedLayer)?await o.associatedLayer.load(r):o;if(!s)return;const n=t.filter((e=>e&&P(e.fieldName)));if(!n||!n.length)return;t.forEach((e=>this._configureRelatedInfo(e,s)));const l=await L({relatedInfos:i,layer:s},r);Object.keys(l).forEach((e=>{var t;const r=i.get(e.toString()),o=null==(t=l[e])?void 0:t.value;r&&o&&(r.layerInfo=o.data)}));const p=await E({graphic:e,relatedInfos:i,layer:s},r);Object.keys(p).forEach((e=>{var t;R(null==(t=p[e])?void 0:t.value,i.get(e.toString()))}))}_configureRelatedInfo(e,t){const{relatedInfos:r}=this,i=O(e.fieldName);if(!i)return;const{layerId:o,fieldName:s}=i;if(!o)return;const a=r.get(o.toString())||S(o,t);a&&(k({relatedInfo:a,fieldName:s,fieldInfo:e}),this.relatedInfos.set(o,a))}};B.interceptor=new r(I,A),e([u()],B.prototype,"_error",void 0),e([u()],B.prototype,"_featureAbortController",void 0),e([u({readOnly:!0})],B.prototype,"_effectivePopupTemplate",null),e([u({readOnly:!0})],B.prototype,"_fieldInfoMap",null),e([u({readOnly:!0})],B.prototype,"_sourceLayer",null),e([u()],B.prototype,"abilities",void 0),e([f("abilities")],B.prototype,"castAbilities",null),e([u({readOnly:!0})],B.prototype,"content",void 0),e([u({readOnly:!0})],B.prototype,"contentViewModels",void 0),e([u({type:Boolean})],B.prototype,"defaultPopupTemplateEnabled",void 0),e([u({readOnly:!0})],B.prototype,"state",null),e([u({readOnly:!0})],B.prototype,"formattedAttributes",void 0),e([u({type:t,value:null})],B.prototype,"graphic",null),e([u({readOnly:!0})],B.prototype,"lastEditInfo",void 0),e([u()],B.prototype,"relatedInfos",void 0),e([u()],B.prototype,"spatialReference",null),e([u({readOnly:!0})],B.prototype,"title",void 0),e([u()],B.prototype,"map",null),e([u({readOnly:!0})],B.prototype,"waitingForContent",null),e([u()],B.prototype,"view",void 0),B=U=e([h(D)],B);var G=B;export{G as default};
