/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{aliasOf as t}from"../core/accessorSupport/decorators/aliasOf.js";import"../core/has.js";import"../core/accessorSupport/ensureType.js";import"../core/Logger.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import{getDomainRange as l}from"../layers/support/domainUtils.js";import{getFieldRange as r}from"../layers/support/fieldUtils.js";import n from"./Widget.js";import s from"./FeatureForm/FeatureFormViewModel.js";import{Heading as o}from"./support/Heading.js";import"./support/widgetUtils.js";import{messageBundle as d}from"./support/decorators/messageBundle.js";import{vmEvent as u}from"./support/decorators/vmEvent.js";import{tsx as p}from"./support/jsxFactory.js";import{DateTime as c}from"luxon";import{getLocale as h}from"../intl/locale.js";const m={base:"esri-feature-form",form:"esri-feature-form__form",formHeader:"esri-feature-form__form-header",label:"esri-feature-form__label",inputField:"esri-feature-form__input",inputDate:"esri-feature-form__input--date",inputTime:"esri-feature-form__input--time",inputRadioGroup:"esri-feature-form__input--radio-group",inputRadio:"esri-feature-form__input--radio",inputRadioLabel:"esri-feature-form__input--radio-label",inputDisabled:"esri-feature-form__input--disabled",inputSwitch:"esri-feature-form__input--switch",inputInvalid:"esri-feature-form__input--invalid",inputIconInvalid:"esri-feature-form__input-icon--invalid",errorMessage:"esri-feature-form__field-error-message",description:"esri-feature-form__description-text",dateInputPart:"esri-feature-form__date-input-part",loneDateInputPart:"esri-feature-form__date-input-part--lone",dateInputContainer:"esri-feature-form__date-input-container",dateFormatHint:"esri-feature-form__date-format-hint",group:"esri-feature-form__group",groupLabel:"esri-feature-form__group-label",groupHeader:"esri-feature-form__group-header",groupHeading:"esri-feature-form__group-header",groupTitle:"esri-feature-form__group-title",groupDescription:"esri-feature-form__group-description",groupToggleIcon:"esri-feature-form__group-toggle-icon",groupCollapsed:"esri-feature-form__group--collapsed",groupSequential:"esri-feature-form__group--sequential",groupActive:"esri-feature-form__group--active",collapseIcon:"esri-icon-up",errorIcon:"esri-icon-notice-triangle",expandIcon:"esri-icon-down",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input",select:"esri-select"},f={datePattern:"D",timePattern:"tt"};function _(e){return e&&e.inputFields}let v=class extends n{constructor(e,t){super(e,t),this._activeDateFieldEdit=null,this._activeInputName=null,this._fieldFocusNeeded=!1,this._fieldToInitialIncompatibleDomainValue=new Map,this._switchFieldsWithInitialIncompatibleValue=new Set,this._userUpdatedInputFieldNames=new Set,this.description=null,this.feature=null,this.fieldConfig=null,this.formTemplate=null,this.groupDisplay="all",this.headingLevel=2,this.label=void 0,this.layer=null,this.messages=null,this.strict=null,this.title=null,this.viewModel=new s,this._handleRadioInputChange=e=>{this._commitInputValue(e.target)},this._handleInputInput=e=>{this._commitInputValue(e.target,!0)},this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterInputCreateOrUpdate=this._afterInputCreateOrUpdate.bind(this)}initialize(){this.own(this.watch("feature",(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e&&e.name,this._userUpdatedInputFieldNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedInputFieldNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}})))}loadDependencies(){return import("@esri/calcite-components/dist/custom-elements/bundles/switch.js")}destroy(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null}getValues(){return null}submit(){return null}render(){const{state:e}=this.viewModel;return p("div",{class:this.classes(m.base,m.widget,m.panel)},"ready"===e?this.renderForm():null)}renderForm(){const e=this.title?p(o,{key:"title",level:this.headingLevel},this.title):null,t=this.description?p("p",{class:m.description,key:"description"},this.description):null,i=e||t?p("div",{class:m.formHeader},e,t):null;return p("form",{class:m.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},i,this.renderFields())}renderFields(){const{viewModel:{inputFields:e}}=this;return e.map(((e,t)=>_(e)?this.renderGroup(e,t):this.renderLabeledField(e)))}renderGroup(e,t){const{description:i,inputFields:a,label:l,state:r}=e,n=this.viewModel.findField(this._activeInputName),s=!(!n||n.group!==e),d=`${this.id}_group_${t}`,u=`${this.id}_group-label_${t}`,c=`${this.id}_group-description_${t}`,h=i?p("p",{class:this.classes(m.groupDescription,m.description),id:c},i):null,f="sequential"===this.groupDisplay,_=f?s:"expanded"===r,v=_?m.collapseIcon:m.expandIcon;return p("fieldset",{"aria-expanded":_.toString(),"aria-labelledby":u,"aria-describedby":i?c:"",class:this.classes(m.group,f?m.groupSequential:null,_?null:m.groupCollapsed,s?m.groupActive:null),"data-group":e,id:d,key:t,onclick:this._handleGroupClick},p("button",{role:f?"presentation":void 0,class:m.groupHeader,type:"button",tabIndex:f?-1:0},p("div",{class:m.groupTitle},p(o,{class:m.groupLabel,id:u,level:this.headingLevel+(this.title?1:0)},l),h),f?null:p("span",{class:this.classes(v,m.groupToggleIcon)})),a.map((e=>this.renderLabeledField(e))))}_getFocusableInput(e,t){const i=this.viewModel._allInputFields,a="forward"===e?i:i.slice().reverse();let l;if(t)if(_(t))l=a.indexOf(t.inputFields[0]);else{let i;if(this._isFieldInClosedCollapsibleGroup(t)){const{inputFields:a}=t.group;i="forward"===e?a[a.length-1]:a[0]}else i=t;l=a.indexOf(i)+1}else l=0;for(let r=l;r<a.length;r++){const e=a[r];if(e.visible)return e}return null}renderLabeledField(e){const{label:t,layer:i,type:a}=e;return p("label",{key:`${i.id}-${e.name}`,class:m.label},[t,"unsupported"!==a?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])}renderInputField(e){const{viewModel:t}=this,{domain:i,editable:a,name:l,type:r}=e,n=t.getValue(l),s=!a,o=this.getCommonInputProps(e);if("coded-value"===(null==i?void 0:i.type)&&!s){if("switch"===e.editorType){if(!(this._switchFieldsWithInitialIncompatibleValue.has(l)||null==n||e.config.onValue!==n&&e.config.offValue!==n))return this.renderSwitchInputField(n,o);this._switchFieldsWithInitialIncompatibleValue.add(l)}return"radio-buttons"===e.editorType?this.renderRadioButtonsInputField(n,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o):this.renderSelectInputField(n,i.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),o)}return"text"===r&&"text-area"===e.editorType||"rich-text"===e.editorType?p("textarea",{...o}):"datetime-picker"===e.editorType||"date"===r?this.renderDateInputField(n,o):p("input",{type:"text"===r?"text":"number",...o})}_parseDateTime(e,t,i){if(i){var a;let l=c.fromJSDate(this._parseDate(e,i));const r=c.fromMillis(null!=(a=t.value)?a:Date.now());return l="date"===i?l.set({hour:r.hour,minute:r.minute,second:r.second}):l.set({day:r.day,month:r.month,year:r.year}),l.isValid?l.toMillis():null}const l=c.fromJSDate(this._parseDate(e));return l.isValid?l.toMillis():null}renderDateInputField(e,t){const{date:i,time:a}=this._formatDate(0),l=`${this.id}-${t.key}`,r=`${l}-date`,n=`${l}-time`,s=t["data-field"],{includeTime:o}=s,{_activeDateFieldEdit:d}=this;let{date:u,time:c}=this._formatDate(e);var h,f,_,v;(null==d?void 0:d.fieldName)===s.name&&(u=null!=(h=null==(f=d.date.input)?void 0:f.value)?h:u,c=null!=(_=null==(v=d.time.input)?void 0:v.value)?_:c);return p("div",{key:`${t.key}-date`,class:m.dateInputContainer},p("div",{class:this.classes(m.dateInputPart,o?null:m.loneDateInputPart)},p("input",{"aria-label":s.label,"aria-describedby":r,type:"text",...t,"data-date-part":"date",class:this.classes(t.class,m.inputDate),value:u}),p("div",{class:m.dateFormatHint,id:r},i)),o?p("div",{class:m.dateInputPart,key:"time-input"},p("input",{"aria-describedby":n,"aria-label":s.label,type:"text",...t,"data-date-part":"time",class:this.classes(t.class,m.inputTime),value:c}),p("div",{class:m.dateFormatHint,id:n},a)):null)}renderUnsupportedField(e){const t=this.getCommonInputProps(e);return p("input",{afterCreate:t.afterCreate,afterUpdate:t.afterUpdate,class:this.classes(m.input,m.inputField,m.inputDisabled),"data-field":t["data-field"],onfocus:t.onfocus,readOnly:!0,tabIndex:t.tabIndex,type:"text",value:t.value})}renderSelectInputField(e,t,i){const a=t.map((e=>p("option",{value:`${e.value}`,key:e.name},e.name))),l=i["data-field"];if(this.registerIncompatibleValue(e,t,l,(e=>{a.unshift(p("option",{value:`${e}`,key:"incompatible-option",readOnly:!0},e))})),!l.required&&("combo-box"!==l.editorType||l.config.showNoValueOption)){var r;const e="",t=(null==(r=l.config)?void 0:r.noValueOptionLabel)||this.messages.empty;a.unshift(p("option",{value:e,key:"empty-option"},t))}return p("select",{...i,class:this.classes(i.class,m.select),onchange:this._handleOptionChange},a)}registerIncompatibleValue(e,t,i,a){const l=this._fieldToInitialIncompatibleDomainValue,r=l.has(i.name);(r||null!=e&&""!==e&&!t.find((t=>t.value===e))||r)&&(r||l.set(i.name,e),null==a||a(l.get(i.name)))}renderRadioButtonsInputField(e,t,i){const a=i["data-field"],l=t.map((t=>this.renderRadioButton({key:t.name,label:t.name,name:a.name,value:t.value,selected:t.value===e,props:i})));if(this.registerIncompatibleValue(e,t,a),!a.required&&(!a.config||a.config.showNoValueOption)){var r;const t="",n=(null==(r=a.config)?void 0:r.noValueOptionLabel)||this.messages.empty,s=e===t||null===e;l.unshift(this.renderRadioButton({key:"empty-option",label:n,name:a.name,value:t,selected:s,props:i}))}return p("div",{key:`${i.key}-radio`,class:m.inputRadioGroup},l)}renderSwitchInputField(e,t){const i=t["data-field"];return p("calcite-switch",{...t,class:m.inputSwitch,switched:e===i.config.onValue,onCalciteSwitchChange:e=>{this._parseValue(e.currentTarget)}})}renderRadioButton({key:e,name:t,value:i,selected:a,label:l,props:r}){return p("label",{key:e,class:m.inputRadioLabel},p("input",{...r,class:m.inputRadio,name:t,type:"radio",value:i,checked:a,onchange:this._handleRadioInputChange}),l)}renderAuxiliaryText(e){return this._userUpdatedInputFieldNames.has(e.name)&&!e.valid?p("div",{key:"error-message"},p("span",{class:this.classes(m.inputIconInvalid,m.errorIcon)}),p("div",{class:m.errorMessage},e.errorMessage)):e.description?p("div",{key:"description",class:m.description},e.description):void 0}getCommonInputProps(e){const{groupDisplay:t,viewModel:i}=this,{editable:a,group:l,hint:r,maxLength:n,minLength:s,name:o,required:d,type:u,valid:p}=e,c=i.getValue(o),h=this._userUpdatedInputFieldNames.has(o),f=!a,_="all"===t&&"collapsed"===(null==l?void 0:l.state);return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":p?"false":"true",class:this.classes(m.input,m.inputField,f?m.inputDisabled:null,h&&!p?m.inputInvalid:null),key:o,minlength:s>-1?`${s}`:"",maxlength:n>-1?`${n}`:"",...this._getNumberFieldConstraints(e),readOnly:f,value:null==c?"":`${c}`,"data-field":e,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===u?this._handleNumberInputMouseDown:null,placeholder:"number"===u||"text"===u?r:"",required:d,tabIndex:_?-1:0}}_isFieldInClosedCollapsibleGroup(e){var t;return"all"===this.groupDisplay&&!_(e)&&"collapsed"===(null==e||null==(t=e.group)?void 0:t.state)}_handleNumberInputMouseDown({target:e}){e.focus(),this.scheduleRender()}_getNumberFieldConstraints(e){const t=l(e.domain)||r(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}}_afterInputCreateOrUpdate(e){const t=e["data-field"],i=this.viewModel.findField(this._activeInputName),a=this._fieldToInitialIncompatibleDomainValue.get(t.name)===t.value;this._fieldFocusNeeded&&i===t&&("radio-buttons"!==t.editorType||a||e.checked)&&(this._fieldFocusNeeded=!1,e.focus())}_handleInputFocus(e){const t=e.target,i=t["data-field"];this._activeInputName=i.name,"date"===i.type&&this._syncDateFieldEdits(t)}_handleInputBlur(e){const t=e.target,i=t["data-field"];if("date"===i.type){const l=e.relatedTarget,r=l&&l["data-field"];if(r&&"date"===i.type&&"date"===r.type&&i.field===r.field){if(""!==t.value&&""===l.value){var a;const r=l.getAttribute("data-date-part");l.value=this._formatDate(null!=(a=i.value)?a:Date.now())[r],this._parseDate(t.value,t.getAttribute("data-date-part"))&&this._commitInputValue(e.target,!0,!1)}return}}this._commitInputValue(t),this.scheduleRender()}_commitInputValue(e,t=!1,i=!0){const a=e["data-field"];if(this._activeDateFieldEdit){const{date:o,time:d}=this._activeDateFieldEdit,u=this._parseDateTime(e.value,a,o.active?"date":"time"),p=null!==this.viewModel.getValue(a.name),c=o.input&&(d.input||!a.includeTime),h=null===u;if(t){if(h)return;(c||!i||p)&&this._updateDateFieldValue(a,u)}else{var l,r;if(""===(null==(l=o.input)?void 0:l.value)||""===(null==(r=d.input)?void 0:r.value))this._updateDateFieldValue(a,null);else if(c){var n,s;const e=`${o.input.value} ${null!=(n=null==(s=d.input)?void 0:s.value)?n:""}`,t=this._parseDateTime(e,a);!(null!==t)&&p||this._updateDateFieldValue(a,t)}this._activeDateFieldEdit=null}}else this._updateFieldValue(e)}_handleInputKeyDown(e){const{key:t,altKey:i,ctrlKey:a,metaKey:l}=e,r=e.target["data-field"];if("Enter"===t)this._isFieldInClosedCollapsibleGroup(r)&&(r.group.state="expanded");else{const{type:n}=r.field,s="single"===n||"double"===n,o=!i&&!a&&!l;if(("integer"===n||"small-integer"===n||s)&&o&&1===t.length){const i=Number(t),a=["-","+"],l=["e","."],r=s?[...a,...l]:a;isNaN(i)&&-1===r.indexOf(t)&&e.preventDefault()}}}_syncDateFieldEdits(e){var t,i;const a=e["data-field"];if("date"!==a.type)return;const l=e.getAttribute("data-date-part"),r="date"===l?{value:e.value,input:e,active:!0}:{...null==(t=this._activeDateFieldEdit)?void 0:t.date,active:!1},n="time"===l?{value:e.value,input:e,active:!0}:{...null==(i=this._activeDateFieldEdit)?void 0:i.time,active:!1};this._activeDateFieldEdit={fieldName:a.name,date:r,time:n}}_updateFieldValue(e){const t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e)),this._userUpdatedInputFieldNames.add(t.name)}_updateDateFieldValue(e,t){this.viewModel.setValue(e.name,t),this._userUpdatedInputFieldNames.add(e.name)}_parseValue(e){const t=e["data-field"],i=e.value;if("switch"===t.editorType&&!(e instanceof HTMLSelectElement))return e.switched?t.config.onValue:t.config.offValue;if("radio-buttons"===t.editorType&&"radio"===e.type&&!e.checked)return t.value;const{type:a}=t;if("number"===a)return i?parseFloat(i):null;if("date"===a){if(!i)return null;const a=Number(i);if(!isNaN(a))return a;const l=e.getAttribute("data-date-part"),r=this._parseDate(i,l);if(!r)return null;let n=c.fromJSDate(r);const s=t.domain,o=c.now();let d=o;if(s&&"range"===s.type){const e=c.fromMillis(s.maxValue);o<e&&(d=e)}const u=this.viewModel.getValue(t.name),p=null!=u?c.fromMillis(u):d;return n="date"===l?n.set({hour:p.hour,minute:p.minute,second:p.second}):n.set({day:p.day,month:p.month,year:p.year}),n.toMillis()}return i}_handleOptionChange(e){this._commitInputValue(e.target),this.scheduleRender()}_handleGroupClick(e){var t;const i=e.currentTarget["data-group"],a="expanded"===i.state,l="sequential"===this.groupDisplay,r=`.${m.groupHeader}`;if(!(a&&!e.target.closest(r))){if(this._activeInputName=null==(t=this._getFocusableInput("forward",i))?void 0:t.name,l){const t=e.target.closest(r);if(a&&!t)return;this.viewModel.inputFields.forEach((e=>{_(e)&&e!==i&&(e.state="collapsed")}))}i.state=a?"collapsed":"expanded",this._fieldFocusNeeded=l,this.scheduleRender()}}_handleSubmit(e){e.preventDefault()}_handleFormKeyDown(e){"Enter"===e.key&&this.viewModel.submit()}_formatDate(e){if(null==e)return{date:"",time:""};const t=c.fromMillis(e,{locale:h(),numberingSystem:"latn"});return{date:t.toLocaleString({year:"numeric",month:"2-digit",day:"2-digit"}),time:t.toFormat(f.timePattern)}}_parseDate(e,t){if(null==e||""===e)return null;const{timePattern:i,datePattern:a}=f,l=t?"date"===t?a:i:`${a} ${i}`,r=c.fromFormat(e,l,{locale:h(),numberingSystem:"latn"});return r.isValid?r.toJSDate():null}};e([t("viewModel.description")],v.prototype,"description",void 0),e([t("viewModel.feature")],v.prototype,"feature",void 0),e([t("viewModel.fieldConfig")],v.prototype,"fieldConfig",void 0),e([t("viewModel.formTemplate")],v.prototype,"formTemplate",void 0),e([i()],v.prototype,"groupDisplay",void 0),e([i()],v.prototype,"headingLevel",void 0),e([i({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],v.prototype,"label",void 0),e([t("viewModel.layer")],v.prototype,"layer",void 0),e([i(),d("esri/widgets/FeatureForm/t9n/FeatureForm")],v.prototype,"messages",void 0),e([t("viewModel.strict")],v.prototype,"strict",void 0),e([t("viewModel.title")],v.prototype,"title",void 0),e([i(),u(["value-change","submit"])],v.prototype,"viewModel",void 0),e([t("viewModel.getValues")],v.prototype,"getValues",null),e([t("viewModel.submit")],v.prototype,"submit",null),v=e([a("esri.widgets.FeatureForm")],v);var g=v;export{g as default};
