/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import"../../../intl.js";import e from"../../../core/Error.js";import{clone as t}from"../../../core/lang.js";import r from"../../../core/Logger.js";import{isSome as i}from"../../../core/maybe.js";import{getMetersPerUnitForSR as n}from"../../../core/unitUtils.js";import l from"../../../geometry/Polygon.js";import{createExtentFromGeometry as o,scaleExtent as s}from"./geometryUtils.js";import{substitute as u}from"../../../intl/substitute.js";import{formatDate as a}from"../../../intl/date.js";const c=/https?:\/\/services.*\.arcgis\.com/i,d=/(?:\{([^}]+)\})/g,f=r.getLogger("esri.widgets.Search.support.layerSearchUtils");function m(t,r){const{exactMatch:i=!1,location:l,maxResults:o,spatialReference:s,source:u,sourceIndex:a,suggestResult:c,view:d}=t,{layer:m,filter:g,zoomScale:F}=u,b=d&&d.scale,j=p(u,d),T=r&&r.signal;return h(m).then((()=>{const e=m.popupTemplate;return e?e.getRequiredFields(m.fieldsIndex):null})).then((t=>{var r,p;const{objectIdField:h,returnZ:R}=m,S=x(u);if(!$(m,S))throw f.error("invalid-field: displayField is invalid."),new e("getResults():invalid-field","displayField is invalid.");const D=t&&t.length?t:[S],E=u.outFields||D,M=y(E);-1!==E.indexOf(h)||M||E.push(h);if(!(M||w(m,E)))throw f.error("invalid-field: outField is invalid."),new e("getResults():invalid-field","outField is invalid.");const O=m.createQuery(),{orderByFields:C}=u;if(C&&(O.orderByFields=C),s){O.outSpatialReference=s;const e=1/n(s);e&&(O.maxAllowableOffset=e)}const N="mesh"===m.geometryType||"multipatch"===m.geometryType,U=(null==(r=m.capabilities)||null==(p=r.data)?void 0:p.supportsZ)&&!N;if(O.returnZ=U&&!1!==R,O.returnGeometry=!0,O.multipatchOption=N?"xyFootprint":null,E&&(O.outFields=E),l)O.geometry=l;else if(c.key)O.objectIds=[c.key];else{const t=u.searchFields||[S];if(!w(m,t))throw f.error("invalid-field: search field is invalid."),new e("getResults():invalid-field","search field is invalid.");v(m)&&(O.num=o),j&&(O.geometry=j);if(!c.text.trim())return[];const{prefix:r="",suffix:n=""}=u,l=L({searchTerm:I(`${r}${c.text}${n}`),layer:m,searchFields:t,filter:g,exactMatch:i,type:"search"});if(!l)return[];O.where=l}return m.queryFeatures(O,{signal:T}).then((e=>k(e,d,u,a,S,b,F)))}))}function g(t,r){const{source:i,spatialReference:n,view:l,suggestTerm:o,maxSuggestions:s,sourceIndex:u,exactMatch:a}=t,{layer:c,filter:m}=i,g=r&&r.signal,F=p(i,l);return h(c).then((()=>{if(!v(c))return[];const t=x(i),r=i.searchFields||[t],l=[];i.suggestionTemplate?i.suggestionTemplate.replace(d,((e,t)=>(l.push(t),e))):l.push(t);const p=y(l);-1!==l.indexOf(c.objectIdField)||p||l.push(c.objectIdField);const h=$(c,t),b=p||w(c,l),j=w(c,r);if(!h)throw f.error("invalid-field: displayField is invalid."),new e("getSuggestions():invalid-field","displayField is invalid.");if(!b)throw f.error("invalid-field: outField is invalid."),new e("getSuggestions():invalid-field","outField is invalid.");if(!j)throw f.error("invalid-field: search field is invalid."),new e("getSuggestions():invalid-field","search field is invalid.");const T=c.createQuery(),{orderByFields:R}=i;R&&(T.orderByFields=R),T.outSpatialReference=n,T.returnGeometry=!1,T.num=s,T.outFields=l,F&&(T.geometry=F);if(!o.trim())return[];const{prefix:S="",suffix:D=""}=i,E=L({searchTerm:I(`${S}${o}${D}`),layer:c,searchFields:r,filter:m,exactMatch:a,type:"suggest"});return E?(T.where=E,c.queryFeatures(T,{signal:g}).then((e=>C(e,i,u,t)))):[]}))}function p(e,t){const{filter:r,withinViewEnabled:i}=e,n=t&&t.extent;return r&&r.geometry||(i&&n?n:void 0)}function y(e){return e&&-1!==e.indexOf("*")}async function h(e){e&&await e.load()}function v(e){var t,r,i;return null!=(t=null==e||null==(r=e.capabilities)||null==(i=r.query)?void 0:i.supportsPagination)&&t}function F(e){var t,r,i,n;return null!=(t=null==e||null==(r=e.fieldsIndex)||null==(i=r.fields)||null==(n=i.find((e=>"string"===e.type)))?void 0:n.name)?t:""}function x(e){return e.displayField||e.layer.displayField||F(e.layer)}function w(e,t){return!(!e||!t)&&t.every((t=>$(e,t)))}function $(e,t){return!!e.getField(t)}function b(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function j(e,t,r){let i=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,l=r?n:n.toLowerCase();return(r?t:t.toLowerCase())===l&&(i=e.code.toString(),!0)})),i}function I(e){return e.replace(/\'/g,"''")}function T(e,t){const r=t&&t.where;return r?`(${e}) AND (${r})`:e}function R({currentTerm:e,field:t,filter:r,exactMatch:i,url:n,type:l}){const o=t.type,s=t.name;if("string"===o||"date"===o||"global-id"===o){const t=c.test(n),o=t&&b(e)?"N":"";if(i&&"search"===l)return T(`${s} = ${o}'${e}'`,r);const u=t?s:`UPPER(${s})`,a=t?e:e.toUpperCase();return T(`${u} LIKE ${o}${i?`'${a}%'`:`'%${a}%'`}`,r)}if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:T(`${s} = ${t}`,r)}return T(`${s} = ${e}`,r)}function S(e,t){return e?` OR (${t})`:`(${t})`}function L({searchTerm:e,layer:t,searchFields:r,filter:i,exactMatch:n,type:l}){const{definitionExpression:o,url:s}=t;let u="";return e&&r&&r.forEach((r=>{const o=t.getField(r),a="function"==typeof t.getFieldDomain&&t.getFieldDomain(r),c=(a&&"coded-value"===a.type?j(a,e,n):null)||e||null;if(null!==c){const e=R({currentTerm:c,field:o,filter:i,exactMatch:n,url:s,type:l});e&&(u+=S(u,e))}})),o?`(${o}) AND (${u})`:u}function D(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(r=e.name,!0))),r}function E(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function M(e,t,r){const i=e.sourceLayer,{attributes:n}=e,l="function"==typeof i.getFieldDomain&&i.getFieldDomain(r);if(t)return u(t,n);if(r&&n){const e=i.getField(r),t=E(n,r);return null==t?"":l&&"coded-value"===l.type?D(l,t):"date"===(null==e?void 0:e.type)?a(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function O(e,t,r,i){const n=e.sourceLayer,{attributes:l}=e,{objectIdField:o}=n,s=l[o];return{text:M(e,t.suggestionTemplate,i),key:s,sourceIndex:r}}function C(e,t,r,i){return e.features.map((e=>O(e,t,r,i)))}function N(e,r,n,u,a,c,d){const f=e.clone(),m=e.sourceLayer,g=m&&m.objectIdField,p=g&&e.attributes[g],y=M(e,n.searchTemplate,a),h=o(f.geometry,r,c),v="number"==typeof d?s(t(h),r,d):h,F=e.clone();return i(v)&&(F.geometry=l.fromExtent(v)),{extent:v,target:F,feature:f,key:p,name:y,sourceIndex:u}}function k(e,t,r,i,n,l,o){return e.features.map((e=>N(e,t,r,i,n,l,o)))}export{m as getResults,g as getSuggestions};
