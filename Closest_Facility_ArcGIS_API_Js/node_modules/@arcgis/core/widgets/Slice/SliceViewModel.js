/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import{castForReferenceSetter as o,referenceSetter as r}from"../../core/collectionUtils.js";import s from"../../core/Handles.js";import i from"../../core/Logger.js";import{isNone as l,isSome as a,destroyMaybe as d}from"../../core/maybe.js";import{ignoreAbortErrors as c}from"../../core/promiseUtils.js";import{react as h}from"../../core/reactiveUtils.js";import{whenTrueOnce as n}from"../../core/watchUtils.js";import{aliasOf as u}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{property as y}from"../../core/accessorSupport/decorators/property.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import m from"../../layers/SliceLayer.js";import w from"../../views/3d/interactive/analysisTools/slice/SliceTool.js";import{InteractiveToolViewModel as f}from"../support/InteractiveToolViewModel.js";const V=i.getLogger("esri.widgets.Slice.SliceViewModel"),v=new Set;let x=class extends f{constructor(e){super(e),this.layerView=null,this.logger=V,this.supportedViewType="3d",this.unsupportedErrorMessage="SliceViewModel is only supported in 3D views.",this.handles=new s,this.model=new m({listMode:"hide"}),this.shape=null,this.tiltEnabled=!1,this.ready=!1,v.add(this)}initialize(){this.handles.add(this.watch("shape",((e,t)=>{l(t)&&a(e)?l(this.tool)&&!this.creatingTool&&this.createTool():a(t)&&l(e)&&this.removeTool()}),!0)),this.handles.add(this.watch("tiltEnabled",(e=>this._updateToolOrRecreate((t=>t.tiltEnabled=e))),!0)),this.handles.add(h((()=>({view:this.view,ready:a(this.view)&&this.view.ready})),(({view:e})=>{this._disconnectFromView(),this._connectToView(e)}),{sync:!0})),this._connectToView(this.view)}destroy(){this._disconnectFromView(),v.delete(this),this.handles=d(this.handles)}get state(){return this.disabled||!this.ready?"disabled":l(this.tool)||"pending"===this.tool.toolState?"ready":this.tool.state}get excludedLayers(){return a(this.layerView)?this.layerView.layerViewData.excludedLayers:this._get("excludedLayers")||new t}set excludedLayers(e){this._set("excludedLayers",r(e,this.excludedLayers)),a(this.layerView)&&(this.layerView.layerViewData.excludedLayers=e)}get excludeGroundSurface(){return a(this.layerView)?this.layerView.layerViewData.excludeGroundSurface:this._get("excludeGroundSurface")||!1}set excludeGroundSurface(e){this._set("excludeGroundSurface",e),a(this.layerView)&&(this.layerView.layerViewData.excludeGroundSurface=e)}async start(){return this.removeTool(),this.ready||await n(this,"ready"),v.forEach((e=>{e.view===this.view&&e!==this&&e.clear()})),this.createTool()}clear(){this.removeTool(),this.excludeGroundSurface=!1,this.excludedLayers=new t}removeSliceAndStart(){return this.removeTool(),this.shape=null,this.start()}enterExcludeLayerMode(){a(this.tool)&&this.tool.enterExcludeLayerMode()}exitExcludeLayerMode(){a(this.tool)&&this.tool.exitExcludeLayerMode()}_updateToolOrRecreate(e){a(this.tool)?e(this.tool):this.creatingTool&&c(this.createTool())}createToolParams(){return{toolConstructor:w,constructorArguments:()=>({tiltEnabled:this.tiltEnabled,analysis:this.model})}}_connectToView(e){if(!l(e)&&e.ready&&(e.map.layers.includes(this.model)||e.map.layers.add(this.model),"3d"===e.type)){const t=e;t.whenLayerView(this.model).then((e=>{this.destroyed||t!==this.view||(e.layerViewData.excludeGroundSurface=this.excludeGroundSurface,e.layerViewData.excludedLayers=this.excludedLayers,this.layerView=e,this.ready=!0)}))}}_disconnectFromView(){this.ready=!1,null!=this.view&&(this.view.map.remove(this.model),this.layerView=null)}};e([y()],x.prototype,"layerView",void 0),e([y({readOnly:!0})],x.prototype,"state",null),e([y()],x.prototype,"model",void 0),e([y({aliasOf:"model.plane"})],x.prototype,"shape",void 0),e([y({aliasOf:"model.tiltEnabled"})],x.prototype,"tiltEnabled",void 0),e([u("tool.layersMode")],x.prototype,"layersMode",void 0),e([y({cast:o})],x.prototype,"excludedLayers",null),e([y({nonNullable:!0})],x.prototype,"excludeGroundSurface",null),e([y()],x.prototype,"ready",void 0),x=e([p("esri.widgets.slice.SliceViewModel")],x);var S=x;export{S as default};
