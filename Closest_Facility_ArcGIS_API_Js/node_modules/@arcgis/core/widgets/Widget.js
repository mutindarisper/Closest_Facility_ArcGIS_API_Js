/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{deprecated as t}from"../core/deprecate.js";import{byId as r}from"../core/domUtils.js";import s from"../core/Evented.js";import o from"../core/Handles.js";import"../core/has.js";import{clone as i}from"../core/lang.js";import n from"../core/Logger.js";import{EsriPromiseMixin as a}from"../core/Promise.js";import{debounce as l,throwIfNotAbortError as d,eachAlways as c}from"../core/promiseUtils.js";import{generateUUID as p}from"../core/uuid.js";import{init as h,whenOnce as m}from"../core/watchUtils.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import{cast as g}from"../core/accessorSupport/decorators/cast.js";import{subclass as y}from"../core/accessorSupport/decorators/subclass.js";import{runTracked as v}from"../core/accessorSupport/tracking.js";import{SimpleTrackingTarget as _}from"../core/accessorSupport/tracking/SimpleTrackingTarget.js";import{createAdvancedProjector as f}from"../libs/maquette-advanced-projector/projector.js";import{commitAssetPath as j}from"./support/componentsUtils.js";import{isWidgetConstructor as w,processWidgets as k,WIDGET_SYMBOL as b}from"./support/jsxWidgetSupport.js";import{getThemeName as S,classes as C}from"./support/widgetUtils.js";import{onLocaleChange as R}from"../intl/locale.js";import{fetchMessageBundle as H}from"../intl/messages.js";const P="esri.widgets.Widget",E=n.getLogger(P);let L=0;const N={widgetIcon:"esri-icon-checkbox-unchecked"};function I(e,t){for(const r in t)null!=e[r]&&("object"==typeof e[r]&&"object"==typeof t[r]?I(e[r],t[r]):e[r]=t[r]);return e}const T=f({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,r=/capture$/i;e.eventHandlerInterceptor=(e,s,o,i)=>{const n=t(e,s,o,i),a=r.test(e);if(!((e=e.replace(r,"")).toLowerCase()in o)||a){const t=e[2].toLowerCase()+e.slice(3),r=e=>n.call(o,e);o.addEventListener(t,r,a);const s=()=>o.removeEventListener(t,r,a),l=i.afterRemoved;i.afterRemoved=e=>{null==l||l(e),s()}}return n}},handleInterceptedEvent(e,t,r,s){const{eventPhase:o,type:i}=s,n=o===Event.CAPTURING_PHASE;let a=`on${i}${n?"capture":""}`;const l=t.properties;(a in l||(a=`on${i[0].toUpperCase()}${i.slice(1)}${n?"Capture":""}`,a in l))&&(e.scheduleRender(),l[a].call(l.bind||r,s))}});let U=!1,$=class extends(a(s.EventedAccessor)){constructor(e,r){super(e,r),this._attached=!1,this._internalHandles=new o,this._projector=T,this.domNode=null,this.iconClass=N.widgetIcon,this.label=this.declaredClass.split(".").pop(),this.visible=!0,this.key=this,this._loadLocale=l((async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const e=await c(this._messageBundleProps.map((async({bundlePath:e,propertyName:t})=>{let r=await H(e);this.uiStrings&&Object.keys(this.uiStrings)&&(r=I(i(r),this.uiStrings)),this[t]=r})));for(const t of e)t.error&&E.error("widget-intl:locale-error",this.declaredClass,t.error)}await this.loadLocale()})),j();const s=["light","dark"],n=S()||"light";s.includes(n)||t(E,"The following themes are deprecated: light-blue, dark-blue, light-green, dark-green, light-purple, dark-purple, light-red, and dark-red.",{version:"4.19",warnOnce:!0,see:"https://developers.arcgis.com/javascript/latest/styling/"});const a="esri-widget-uid-"+p(),d=this.render.bind(this);let h=!1;this._trackingTarget=new _((()=>this.scheduleRender()));const m=()=>{var e;if(!h||this.destroyed)return null;if(!this.visible)return{vnodeSelector:"div",properties:{key:a,class:"",styles:{display:"none"}},domNode:void 0,children:void 0,text:void 0};const t=d();let{properties:r}=t;r||(t.properties=r={});let{key:s,styles:o}=r;s||(r.key=a),o||(r.styles=o={}),o.display||(o.display="");let i=0;return null==(e=t.children)||e.forEach((e=>{if(w(e.vnodeSelector))return;let{properties:t}=e;t||(e.properties=t={}),t.key||(t.key=`${this.id}--${i++}`)})),k(this,t)};this.render=()=>{if(U)return m();let e;this._trackingTarget.clear(),U=!0;try{e=v(this._trackingTarget,m)}finally{U=!1}return e},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then((()=>{h=!0,this._postInitialize()})))}normalizeCtorArgs(e,t){const r={...e};return t&&(r.container=t),r}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then((()=>{})).catch(d)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(this._trackingTarget.destroy(),this._trackingTarget=null,this.viewModel&&(this.viewModel.destroy(),this.viewModel=null),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null)}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return r(e)}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+L++}set id(e){e&&this._set("id",e)}get renderable(){return this._resourcesFetch}get test(){return{projector:this._projector,handles:this._internalHandles}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||this._projector.scheduleRender()}classes(...e){return C.apply(this,e)}own(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments)),this._internalHandles.add(e)}renderNow(){this._projector.renderNow()}_postInitialize(){var e;if(this.destroyed)return;this.scheduleRender(),null!=(e=this._delegatedEventNames)&&e.length&&this._internalHandles.add(h(this,"viewModel",((e,t)=>{t&&this._internalHandles.remove("delegated-events"),e&&this._internalHandles.add(this._delegatedEventNames.map((t=>e.on(t,(e=>{this.emit(t,e)})))),"delegated-events")}))),this.postInitialize();const t=async()=>{await this._loadLocale().catch(d),this.scheduleRender()};this._internalHandles.add([R(t),this.watch("uiStrings",t),m(this,"container",(async e=>{this.destroyed||this._attach(e)}))])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){e&&this._attached&&(this._projector.detach(this.render),e.parentNode&&e.parentNode.removeChild(e),this._attached=!1)}};$[b]=!0,e([u({value:null})],$.prototype,"container",null),e([g("container")],$.prototype,"castContainer",null),e([u({aliasOf:"container"})],$.prototype,"domNode",void 0),e([u()],$.prototype,"iconClass",void 0),e([u()],$.prototype,"id",null),e([u()],$.prototype,"label",void 0),e([u()],$.prototype,"renderable",null),e([u()],$.prototype,"uiStrings",void 0),e([u()],$.prototype,"viewModel",void 0),e([u()],$.prototype,"visible",void 0),e([u()],$.prototype,"key",void 0),e([u()],$.prototype,"children",void 0),e([u()],$.prototype,"afterCreate",void 0),e([u()],$.prototype,"afterUpdate",void 0),e([u()],$.prototype,"afterRemoved",void 0),$=e([y(P)],$);var x=$;export{x as default};
