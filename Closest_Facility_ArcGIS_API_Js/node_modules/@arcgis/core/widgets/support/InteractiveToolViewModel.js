/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.21/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import o from"../../core/Accessor.js";import e from"../../core/Error.js";import s from"../../core/Handles.js";import{destroyMaybe as i,isSome as r,abortMaybe as l,isNone as a}from"../../core/maybe.js";import{createTask as n,throwIfAborted as h,isAborted as p}from"../../core/promiseUtils.js";import{init as c,whenOnce as d}from"../../core/watchUtils.js";import{property as u}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Logger.js";import{subclass as v}from"../../core/accessorSupport/decorators/subclass.js";import{evaluateToolConstructorArguments as m}from"../../views/interactive/interactiveToolUtils.js";let w=class extends o{constructor(t){super(t),this.tool=null,this._baseHandles=new s,this._loggedUnsupportedErrorOnce=!1,this._toolCreationTask=null,t&&null!=t.visible&&(this.visible=t.visible)}initialize(){this._baseHandles.add(c(this,["view.ready","isSupported"],(()=>{!(this.view&&this.view.ready)||this.supported||this._loggedUnsupportedErrorOnce||(this.logError(this.unsupportedErrorMessage),this._loggedUnsupportedErrorOnce=!0)})))}destroy(){this.removeTool(),this.view=null,this._baseHandles=i(this._baseHandles)}get supported(){return!this.view||this.view.type===this.supportedViewType}get view(){return this._get("view")}set view(t){if(t===this.view)return;this.removeTool(),this._set("view",t);const o="tools";this._baseHandles.remove(o),t&&this._baseHandles.add(t.tools.on("change",(t=>{if(this.tool)for(const o of t.removed)if(this.tool===o){o.destroyed||o.destroy(),this._set("tool",null);break}})),o)}set visible(t){this._set("visible",t),r(this.tool)&&(this.tool.visible=t),t||(this._toolCreationTask=l(this._toolCreationTask))}get active(){return r(this._toolCreationTask)||r(this.tool)&&this.tool.active}get disabled(){return!this.view||!this.view.ready||!this.supported}get creatingTool(){return r(this._toolCreationTask)}async createTool(){const t="Tool creation was interrupted by another tool being created.";if(r(this.tool)&&this.tool.rejectCreation(t),this.removeTool(),!this.supported)return Promise.reject(new e("tool:create","The view does not support the tool.",this.unsupportedErrorMessage));this._toolCreationTask=n((async o=>{await this.view.whenReady(),h(o,t);const e=this.createToolParams(),s=m(e.constructorArguments),i=new e.toolConstructor({visible:this.visible,...s,view:this.view});return await i.whenCreationStarted(),p(o)&&i.rejectCreation(t),h(o,t),i}));const o=await this._toolCreationTask.promise;this._set("tool",o),this.view.addAndActivateTool(o),d(o,"completed").then((()=>{o.active&&(this.view.activeTool=null)}))}removeTool(){this._toolCreationTask=l(this._toolCreationTask),a(this.tool)||(this.view&&this.view.tools&&this.view.tools.remove(this.tool),this.tool.rejectCreation("Rejecting creation because tool is removed."),this.tool.destroyed||this.tool.destroy(),this._set("tool",null))}logError(...t){this.logger.error(...t)}};t([u({constructOnly:!0})],w.prototype,"tool",void 0),t([u()],w.prototype,"supported",null),t([u({value:null})],w.prototype,"view",null),t([u({type:Boolean,value:!0})],w.prototype,"visible",null),t([u()],w.prototype,"active",null),t([u()],w.prototype,"disabled",null),t([u()],w.prototype,"_toolCreationTask",void 0),t([u({readOnly:!0})],w.prototype,"creatingTool",null),w=t([v("esri.widgets.support.InteractiveToolViewModel")],w);export{w as InteractiveToolViewModel};
